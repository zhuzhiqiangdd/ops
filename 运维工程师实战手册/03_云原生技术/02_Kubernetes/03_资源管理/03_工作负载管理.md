# Kuberneteså·¥ä½œè´Ÿè½½ç®¡ç†

## 1. åŸºç¡€ä¿¡æ¯
### æ–‡æ¡£ä¿¡æ¯
- ç‰ˆæœ¬: v1.0.0
- æ›´æ–°æ—¶é—´: 2024-03-21
- çŠ¶æ€: [ğŸ—ï¸è¿›è¡Œä¸­]
- ä½œè€…: System Admin

### ä¿®è®¢å†å²
| ç‰ˆæœ¬ | æ—¥æœŸ | æè¿° | ä½œè€… |
|-----|------|-----|-----|
| v1.0.0 | 2024-03-21 | åˆå§‹ç‰ˆæœ¬ | System Admin |

## 2. Podç®¡ç†

### 2.1 Podç”Ÿå‘½å‘¨æœŸ
1. Podé˜¶æ®µ
- Pending: Podå·²åˆ›å»ºä½†å®¹å™¨æœªå®Œå…¨è¿è¡Œ
- Running: Podå·²ç»‘å®šèŠ‚ç‚¹ä¸”å®¹å™¨å·²è¿è¡Œ
- Succeeded: Podä¸­æ‰€æœ‰å®¹å™¨å·²æˆåŠŸç»ˆæ­¢
- Failed: Podä¸­è‡³å°‘ä¸€ä¸ªå®¹å™¨ç»ˆæ­¢å¤±è´¥
- Unknown: æ— æ³•è·å–PodçŠ¶æ€

2. å®¹å™¨çŠ¶æ€
- Waiting: å®¹å™¨ç­‰å¾…å¯åŠ¨
- Running: å®¹å™¨æ­£åœ¨è¿è¡Œ
- Terminated: å®¹å™¨å·²ç»ˆæ­¢

3. é‡å¯ç­–ç•¥
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: myapp
spec:
  restartPolicy: Always  # Always|OnFailure|Never
  containers:
  - name: myapp
    image: nginx:1.14.2
```

### 2.2 Podé…ç½®

1. èµ„æºè¯·æ±‚ä¸é™åˆ¶
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: frontend
spec:
  containers:
  - name: app
    image: nginx
    resources:
      requests:
        memory: "64Mi"
        cpu: "250m"
      limits:
        memory: "128Mi"
        cpu: "500m"
```

2. å¥åº·æ£€æŸ¥
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: liveness-http
spec:
  containers:
  - name: liveness
    image: nginx
    livenessProbe:
      httpGet:
        path: /healthz
        port: 8080
      initialDelaySeconds: 3
      periodSeconds: 3
    readinessProbe:
      httpGet:
        path: /ready
        port: 8080
      initialDelaySeconds: 5
      periodSeconds: 5
```

3. ç¯å¢ƒå˜é‡
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: env-demo
spec:
  containers:
  - name: env-demo
    image: nginx
    env:
    - name: DEMO_GREETING
      value: "Hello from the environment"
    - name: DEMO_FAREWELL
      valueFrom:
        configMapKeyRef:
          name: demo-config
          key: farewell
```

### 2.3 Podè°ƒåº¦

1. èŠ‚ç‚¹é€‰æ‹©å™¨
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  nodeSelector:
    disktype: ssd
  containers:
  - name: nginx
    image: nginx
```

2. äº²å’Œæ€§å’Œåäº²å’Œæ€§
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: zone
            operator: In
            values:
            - zone1
            - zone2
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: app
              operator: In
              values:
              - nginx
          topologyKey: kubernetes.io/hostname
  containers:
  - name: nginx
    image: nginx
```

## 3. Deploymentç®¡ç†

### 3.1 åˆ›å»ºå’Œæ›´æ–°

1. åŸºæœ¬åˆ›å»º
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
        ports:
        - containerPort: 80
```

2. æ›´æ–°ç­–ç•¥
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
```

3. å›æ»šæ“ä½œ
```bash
# æŸ¥çœ‹å†å²ç‰ˆæœ¬
kubectl rollout history deployment/nginx-deployment

# æŸ¥çœ‹ç‰¹å®šç‰ˆæœ¬è¯¦æƒ…
kubectl rollout history deployment/nginx-deployment --revision=2

# å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
kubectl rollout undo deployment/nginx-deployment

# å›æ»šåˆ°ç‰¹å®šç‰ˆæœ¬
kubectl rollout undo deployment/nginx-deployment --to-revision=2
```

### 3.2 æ‰©ç¼©å®¹

1. æ‰‹åŠ¨æ‰©ç¼©å®¹
```bash
# å‘½ä»¤è¡Œæ–¹å¼
kubectl scale deployment nginx-deployment --replicas=5

# é…ç½®æ–‡ä»¶æ–¹å¼
kubectl patch deployment nginx-deployment -p '{"spec":{"replicas":5}}'
```

2. è‡ªåŠ¨æ‰©ç¼©å®¹
```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: nginx-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: nginx-deployment
  minReplicas: 1
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 50
```

### 3.3 é‡‘ä¸é›€å‘å¸ƒ

1. åŸºäºæ ‡ç­¾çš„é‡‘ä¸é›€
```yaml
# æ–°ç‰ˆæœ¬Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-canary
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
      version: v2
  template:
    metadata:
      labels:
        app: nginx
        version: v2
    spec:
      containers:
      - name: nginx
        image: nginx:1.15.0
```

2. åŸºäºIngressçš„é‡‘ä¸é›€
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nginx-ingress
  annotations:
    nginx.ingress.kubernetes.io/canary: "true"
    nginx.ingress.kubernetes.io/canary-weight: "20"
spec:
  rules:
  - host: nginx.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-canary
            port:
              number: 80
```

## 4. StatefulSetç®¡ç†

### 4.1 åŸºæœ¬é…ç½®

1. åˆ›å»ºStatefulSet
```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: web
spec:
  serviceName: "nginx"
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
        ports:
        - containerPort: 80
          name: web
        volumeMounts:
        - name: www
          mountPath: /usr/share/nginx/html
  volumeClaimTemplates:
  - metadata:
      name: www
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 1Gi
```

2. æ›´æ–°ç­–ç•¥
```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: web
spec:
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      partition: 2
```

### 4.2 å­˜å‚¨ç®¡ç†

1. æŒä¹…åŒ–å­˜å‚¨
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-1
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: /data/pv-1

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: www-web-0
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
```

2. åŠ¨æ€ä¾›åº”
```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp2
```

### 4.3 ç½‘ç»œç®¡ç†

1. Headless Service
```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx
spec:
  clusterIP: None
  selector:
    app: nginx
  ports:
  - port: 80
```

2. Podç½‘ç»œæ ‡è¯†
```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx-individual
spec:
  selector:
    app: nginx
  ports:
  - port: 80
  type: ClusterIP
```

## 5. DaemonSetç®¡ç†

### 5.1 åŸºæœ¬é…ç½®

1. åˆ›å»ºDaemonSet
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd-elasticsearch
spec:
  selector:
    matchLabels:
      name: fluentd-elasticsearch
  template:
    metadata:
      labels:
        name: fluentd-elasticsearch
    spec:
      containers:
      - name: fluentd-elasticsearch
        image: quay.io/fluentd_elasticsearch/fluentd:v2.5.2
```

2. èŠ‚ç‚¹é€‰æ‹©
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd-elasticsearch
spec:
  template:
    spec:
      nodeSelector:
        type: logging
```

### 5.2 æ›´æ–°ç­–ç•¥

1. æ»šåŠ¨æ›´æ–°
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd-elasticsearch
spec:
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
```

2. åˆ†æ‰¹æ›´æ–°
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd-elasticsearch
spec:
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 10%
```

## 6. Jobå’ŒCronJobç®¡ç†

### 6.1 Jobé…ç½®

1. åŸºæœ¬Job
```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: pi
spec:
  template:
    spec:
      containers:
      - name: pi
        image: perl
        command: ["perl",  "-Mbignum=bpi", "-wle", "print bpi(2000)"]
      restartPolicy: Never
  backoffLimit: 4
```

2. å¹¶è¡ŒJob
```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: parallel-pi
spec:
  completions: 5
  parallelism: 2
  template:
    spec:
      containers:
      - name: pi
        image: perl
        command: ["perl",  "-Mbignum=bpi", "-wle", "print bpi(2000)"]
      restartPolicy: Never
```

### 6.2 CronJobé…ç½®

1. åŸºæœ¬CronJob
```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: hello
spec:
  schedule: "*/1 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: hello
            image: busybox
            command: ["/bin/sh",  "-c", "date; echo Hello from the Kubernetes cluster"]
          restartPolicy: OnFailure
```

2. å¹¶å‘ç­–ç•¥
```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: hello
spec:
  schedule: "*/1 * * * *"
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: hello
            image: busybox
            command: ["/bin/sh", "-c", "date; echo Hello"]
          restartPolicy: OnFailure
```

## 7. é…ç½®ç®¡ç†

### 7.1 ConfigMap

1. åˆ›å»ºConfigMap
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: game-config
data:
  game.properties: |
    enemies=aliens
    lives=3
    enemies.cheat=true
    enemies.cheat.level=noGoodRotten
  ui.properties: |
    color.good=purple
    color.bad=yellow
    allow.textmode=true
```

2. ä½¿ç”¨ConfigMap
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: configmap-demo-pod
spec:
  containers:
    - name: demo
      image: alpine
      command: ["sleep", "3600"]
      env:
        - name: PLAYER_INITIAL_LIVES
          valueFrom:
            configMapKeyRef:
              name: game-config
              key: lives
      volumeMounts:
      - name: config
        mountPath: "/config"
        readOnly: true
  volumes:
    - name: config
      configMap:
        name: game-config
```

### 7.2 Secret

1. åˆ›å»ºSecret
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: mysecret
type: Opaque
data:
  username: YWRtaW4=
  password: MWYyZDFlMmU2N2Rm
```

2. ä½¿ç”¨Secret
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: secret-demo-pod
spec:
  containers:
  - name: demo
    image: nginx
    env:
    - name: USERNAME
      valueFrom:
        secretKeyRef:
          name: mysecret
          key: username
    volumeMounts:
    - name: secret-volume
      mountPath: "/etc/secret"
      readOnly: true
  volumes:
  - name: secret-volume
    secret:
      secretName: mysecret
```

## 8. æœ€ä½³å®è·µ

### 8.1 èµ„æºç®¡ç†

1. èµ„æºè¯·æ±‚å’Œé™åˆ¶
- å§‹ç»ˆè®¾ç½®èµ„æºè¯·æ±‚å’Œé™åˆ¶
- æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè°ƒæ•´
- é¿å…è¿‡åº¦åˆ†é…
- ç›‘æ§èµ„æºä½¿ç”¨æƒ…å†µ

2. æ ‡ç­¾ç®¡ç†
- ä½¿ç”¨æœ‰æ„ä¹‰çš„æ ‡ç­¾
- ä¿æŒæ ‡ç­¾ä¸€è‡´æ€§
- é¿å…è¿‡å¤šæ ‡ç­¾
- å®šæœŸæ¸…ç†æ— ç”¨æ ‡ç­¾

3. å‘½åç©ºé—´è§„åˆ’
- æŒ‰ç¯å¢ƒåˆ’åˆ†
- æŒ‰å›¢é˜Ÿåˆ’åˆ†
- æŒ‰é¡¹ç›®åˆ’åˆ†
- è®¾ç½®èµ„æºé…é¢

### 8.2 é«˜å¯ç”¨éƒ¨ç½²

1. å¤šå‰¯æœ¬ç­–ç•¥
- åˆç†è®¾ç½®å‰¯æœ¬æ•°
- ä½¿ç”¨Podåäº²å’Œæ€§
- é…ç½®å­˜æ´»å’Œå°±ç»ªæ¢é’ˆ
- å®ç°æ»šåŠ¨æ›´æ–°

2. æœåŠ¡å®¹é”™
- ä½¿ç”¨PodDisruptionBudget
- é…ç½®ä¼˜é›…ç»ˆæ­¢
- å®ç°æ•…éšœè½¬ç§»
- å®šæœŸå¤‡ä»½æ•°æ®

3. ç›‘æ§å‘Šè­¦
- éƒ¨ç½²ç›‘æ§ç³»ç»Ÿ
- é…ç½®èµ„æºå‘Šè­¦
- ç›‘æ§åº”ç”¨å¥åº·
- åŠæ—¶å“åº”å‘Šè­¦

### 8.3 æ€§èƒ½ä¼˜åŒ–

1. å®¹å™¨ä¼˜åŒ–
- ä½¿ç”¨è½»é‡çº§åŸºç¡€é•œåƒ
- ä¼˜åŒ–é•œåƒå±‚æ•°
- åˆç†è®¾ç½®èµ„æºé™åˆ¶
- ä½¿ç”¨å¤šé˜¶æ®µæ„å»º

2. è°ƒåº¦ä¼˜åŒ–
- åˆç†ä½¿ç”¨äº²å’Œæ€§
- ä¼˜åŒ–èŠ‚ç‚¹é€‰æ‹©
- é¿å…èµ„æºç¢ç‰‡
- ä½¿ç”¨è‡ªåŠ¨æ‰©ç¼©å®¹

3. ç½‘ç»œä¼˜åŒ–
- ä½¿ç”¨Serviceç½‘ç»œ
- é…ç½®ç½‘ç»œç­–ç•¥
- ä¼˜åŒ–DNSç­–ç•¥
- ä½¿ç”¨CDNåŠ é€Ÿ

## ç›¸å…³æ–‡æ¡£
- [é›†ç¾¤éƒ¨ç½²é…ç½®](./01_é›†ç¾¤éƒ¨ç½²é…ç½®.md)
- [æ ¸å¿ƒæ¦‚å¿µç»„ä»¶](./02_æ ¸å¿ƒæ¦‚å¿µç»„ä»¶.md)
- [æœåŠ¡ä¸ç½‘ç»œ](./04_æœåŠ¡ä¸ç½‘ç»œ.md)

## å‚è€ƒèµ„æ–™
1. [Kubernetes Workloads](https://kubernetes.io/docs/concepts/workloads/)
2. [Kubernetes Configuration](https://kubernetes.io/docs/concepts/configuration/)
3. [Kubernetes Storage](https://kubernetes.io/docs/concepts/storage/)
4. [Kubernetes Best Practices](https://kubernetes.io/docs/concepts/configuration/overview/) 