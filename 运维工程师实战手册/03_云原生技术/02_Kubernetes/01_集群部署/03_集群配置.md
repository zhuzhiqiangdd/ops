# Kubernetesé›†ç¾¤éƒ¨ç½²é…ç½®

## 1. åŸºç¡€ä¿¡æ¯
### æ–‡æ¡£ä¿¡æ¯
- ç‰ˆæœ¬: v1.0.0
- æ›´æ–°æ—¶é—´: 2024-03-21
- çŠ¶æ€: [ğŸ—ï¸è¿›è¡Œä¸­]
- ä½œè€…: System Admin

### ä¿®è®¢å†å²
| ç‰ˆæœ¬ | æ—¥æœŸ | æè¿° | ä½œè€… |
|-----|------|-----|-----|
| v1.0.0 | 2024-03-21 | åˆå§‹ç‰ˆæœ¬ | System Admin |

### ç›®æ ‡è¯»è€…
- ç³»ç»Ÿè¿ç»´å·¥ç¨‹å¸ˆ
- å¹³å°ç®¡ç†å‘˜
- DevOpså·¥ç¨‹å¸ˆ
- æ¶æ„è®¾è®¡å¸ˆ

### å‰ç½®çŸ¥è¯†
- Linuxç³»ç»Ÿç®¡ç†
- å®¹å™¨æŠ€æœ¯åŸºç¡€
- ç½‘ç»œåŸºç¡€çŸ¥è¯†
- å­˜å‚¨ç³»ç»ŸåŸºç¡€

## 2. ç¯å¢ƒå‡†å¤‡
### ç³»ç»Ÿè¦æ±‚
```bash
# ç¡¬ä»¶é…ç½®å»ºè®®
MasterèŠ‚ç‚¹:
- CPU: 2æ ¸ä»¥ä¸Š
- å†…å­˜: 4GBä»¥ä¸Š
- ç¡¬ç›˜: 50GBä»¥ä¸Š

WorkerèŠ‚ç‚¹:
- CPU: 4æ ¸ä»¥ä¸Š
- å†…å­˜: 8GBä»¥ä¸Š
- ç¡¬ç›˜: 100GBä»¥ä¸Š

# æ“ä½œç³»ç»Ÿè¦æ±‚
- CentOS 7.9/8.x
- Ubuntu 20.04/22.04
- å†…æ ¸ç‰ˆæœ¬ >= 3.10
```

### ç³»ç»Ÿé…ç½®
```bash
# å…³é—­é˜²ç«å¢™
systemctl stop firewalld
systemctl disable firewalld

# å…³é—­SELinux
setenforce 0
sed -i 's/^SELINUX=enforcing$/SELINUX=disabled/' /etc/selinux/config

# å…³é—­swap
swapoff -a
sed -i '/swap/d' /etc/fstab

# é…ç½®å†…æ ¸å‚æ•°
cat > /etc/sysctl.d/k8s.conf << EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
vm.swappiness = 0
vm.overcommit_memory = 1
vm.panic_on_oom = 0
fs.inotify.max_user_watches = 89100
fs.file-max = 52706963
fs.nr_open = 52706963
EOF
sysctl --system

# é…ç½®å†…æ ¸æ¨¡å—
cat > /etc/modules-load.d/k8s.conf << EOF
br_netfilter
ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_sh
nf_conntrack
EOF
modprobe br_netfilter
modprobe ip_vs
modprobe ip_vs_rr
modprobe ip_vs_wrr
modprobe ip_vs_sh
modprobe nf_conntrack

# é…ç½®æ—¶é—´åŒæ­¥
apt install -y chrony
systemctl enable chronyd
systemctl start chronyd
chronyc sources

# é…ç½®ulimit
cat > /etc/security/limits.d/k8s.conf << EOF
* soft nofile 65536
* hard nofile 65536
* soft nproc 65536
* hard nproc 65536
* soft memlock unlimited
* hard memlock unlimited
EOF
```

### ç½‘ç»œé…ç½®
```bash
# é…ç½®hosts
cat >> /etc/hosts << EOF
192.168.1.10 k8s-master01
192.168.1.11 k8s-master02
192.168.1.12 k8s-master03
192.168.1.21 k8s-node01
192.168.1.22 k8s-node02
192.168.1.23 k8s-node03
EOF

# é…ç½®ç½‘å¡å‚æ•°
cat > /etc/sysconfig/network-scripts/ifcfg-eth0 << EOF
TYPE=Ethernet
BOOTPROTO=none
NAME=eth0
DEVICE=eth0
ONBOOT=yes
IPADDR=192.168.1.10
NETMASK=255.255.255.0
GATEWAY=192.168.1.1
DNS1=8.8.8.8
EOF

# é‡å¯ç½‘ç»œ
systemctl restart network
```

## 3. ç»„ä»¶å®‰è£…
### å®¹å™¨è¿è¡Œæ—¶
```bash
# å®‰è£…containerd
apt install -y containerd.io

# é…ç½®containerd
mkdir -p /etc/containerd
containerd config default > /etc/containerd/config.toml

# ä¿®æ”¹é…ç½®
sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
sed -i 's/registry.k8s.io/registry.aliyuncs.com\/google_containers/' /etc/containerd/config.toml

# é…ç½®é•œåƒåŠ é€Ÿ
cat >> /etc/containerd/config.toml << EOF
[plugins."io.containerd.grpc.v1.cri".registry.mirrors."docker.io"]
  endpoint = ["https://mirror.ccs.tencentyun.com"]
EOF

# å¯åŠ¨æœåŠ¡
systemctl enable containerd
systemctl restart containerd
```

### kubeadmå·¥å…·é“¾
```bash
# æ·»åŠ aptæº
curl -s https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -
cat > /etc/apt/sources.list.d/kubernetes.list << EOF
deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
EOF

# å®‰è£…å·¥å…·
apt update
apt install -y kubelet kubeadm kubectl
systemctl enable kubelet

# é…ç½®kubelet
cat > /etc/sysconfig/kubelet << EOF
KUBELET_EXTRA_ARGS="--cgroup-driver=systemd"
EOF
```

## 4. é›†ç¾¤åˆå§‹åŒ–
### MasterèŠ‚ç‚¹
```bash
# ç”Ÿæˆåˆå§‹åŒ–é…ç½®
cat > kubeadm-config.yaml << EOF
apiVersion: kubeadm.k8s.io/v1beta3
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: 192.168.1.10
  bindPort: 6443
nodeRegistration:
  criSocket: unix:///run/containerd/containerd.sock
---
apiVersion: kubeadm.k8s.io/v1beta3
kind: ClusterConfiguration
kubernetesVersion: v1.28.0
imageRepository: registry.aliyuncs.com/google_containers
networking:
  podSubnet: 10.244.0.0/16
  serviceSubnet: 10.96.0.0/12
  dnsDomain: cluster.local
controlPlaneEndpoint: "192.168.1.10:6443"
---
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
cgroupDriver: systemd
---
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration
mode: ipvs
EOF

# åˆå§‹åŒ–é›†ç¾¤
kubeadm init --config=kubeadm-config.yaml --upload-certs

# é…ç½®kubectl
mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config

# å®‰è£…ç½‘ç»œæ’ä»¶(Calico)
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/tigera-operator.yaml
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/custom-resources.yaml
```

### WorkerèŠ‚ç‚¹
```bash
# åŠ å…¥é›†ç¾¤
kubeadm join 192.168.1.10:6443 --token <token> \
    --discovery-token-ca-cert-hash sha256:<hash>

# æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€
kubectl get nodes
```

## 5. é«˜å¯ç”¨é…ç½®
### HAProxyé…ç½®
```bash
# å®‰è£…HAProxy
apt install -y haproxy

# é…ç½®HAProxy
cat > /etc/haproxy/haproxy.cfg << EOF
global
    log /dev/log    local0
    log /dev/log    local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

frontend kubernetes-apiserver
    bind *:6443
    mode tcp
    option tcplog
    default_backend kubernetes-apiserver

backend kubernetes-apiserver
    mode tcp
    option tcp-check
    balance roundrobin
    server k8s-master01 192.168.1.10:6443 check fall 3 rise 2
    server k8s-master02 192.168.1.11:6443 check fall 3 rise 2
    server k8s-master03 192.168.1.12:6443 check fall 3 rise 2
EOF

# å¯åŠ¨HAProxy
systemctl enable haproxy
systemctl restart haproxy
```

### Keepalivedé…ç½®
```bash
# å®‰è£…Keepalived
apt install -y keepalived

# é…ç½®Keepalived
cat > /etc/keepalived/keepalived.conf << EOF
global_defs {
    router_id LVS_DEVEL
    script_user root
    enable_script_security
}

vrrp_script check_haproxy {
    script "killall -0 haproxy"
    interval 3
    weight -2
    fall 10
    rise 2
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        192.168.1.100
    }
    track_script {
        check_haproxy
    }
}
EOF

# å¯åŠ¨Keepalived
systemctl enable keepalived
systemctl restart keepalived
```

## 6. åŸºç¡€é…ç½®
### å‘½åç©ºé—´ç®¡ç†
```bash
# åˆ›å»ºå‘½åç©ºé—´
kubectl create namespace monitoring
kubectl create namespace logging
kubectl create namespace ingress-nginx

# é…ç½®èµ„æºé…é¢
cat > quota.yaml << EOF
apiVersion: v1
kind: ResourceQuota
metadata:
  name: compute-quota
  namespace: monitoring
spec:
  hard:
    requests.cpu: "4"
    requests.memory: 8Gi
    limits.cpu: "8"
    limits.memory: 16Gi
EOF
kubectl apply -f quota.yaml
```

### ç½‘ç»œç­–ç•¥
```yaml
# é»˜è®¤ç½‘ç»œç­–ç•¥
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny
  namespace: monitoring
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: monitoring
```

### å­˜å‚¨é…ç½®
```yaml
# æœ¬åœ°å­˜å‚¨ç±»
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-storage
provisioner: kubernetes.io/no-provisioner
volumeBindingMode: WaitForFirstConsumer
```

### èµ„æºé™åˆ¶
```yaml
# LimitRangeé…ç½®
apiVersion: v1
kind: LimitRange
metadata:
  name: mem-limit-range
  namespace: monitoring
spec:
  limits:
  - default:
      memory: 512Mi
      cpu: 500m
    defaultRequest:
      memory: 256Mi
      cpu: 200m
    type: Container
```

## 7. éªŒè¯æµ‹è¯•
### é›†ç¾¤éªŒè¯
```bash
# æ£€æŸ¥ç»„ä»¶çŠ¶æ€
kubectl get componentstatuses
kubectl get pods -n kube-system

# æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
kubectl get nodes
kubectl describe node k8s-master01

# æ£€æŸ¥ç½‘ç»œçŠ¶æ€
kubectl get pods -n calico-system
kubectl get pods -A -o wide
```

### åŠŸèƒ½æµ‹è¯•
```bash
# éƒ¨ç½²æµ‹è¯•åº”ç”¨
kubectl create deployment nginx --image=nginx:latest
kubectl scale deployment nginx --replicas=3
kubectl expose deployment nginx --port=80 --type=NodePort

# éªŒè¯æœåŠ¡è®¿é—®
kubectl get svc nginx
curl http://NodeIP:NodePort

# éªŒè¯Podè°ƒåº¦
kubectl get pods -o wide
kubectl describe pod nginx-xxxxxx
```

### æ€§èƒ½æµ‹è¯•
```bash
# å‹åŠ›æµ‹è¯•
kubectl run -i --tty load-generator --rm --image=busybox --restart=Never -- /bin/sh -c "while sleep 0.01; do wget -q -O- http://nginx; done"

# èµ„æºç›‘æ§
kubectl top nodes
kubectl top pods -A
```

## 8. æ•…éšœæ’æŸ¥
### å¸¸è§é—®é¢˜
1. èŠ‚ç‚¹NotReady
```bash
# æ£€æŸ¥kubeletçŠ¶æ€
systemctl status kubelet
journalctl -u kubelet -f

# æ£€æŸ¥å®¹å™¨è¿è¡Œæ—¶
systemctl status containerd
crictl ps
crictl pods
```

2. Podå¯åŠ¨å¤±è´¥
```bash
# æŸ¥çœ‹PodçŠ¶æ€
kubectl describe pod <pod-name>
kubectl logs <pod-name>

# æ£€æŸ¥äº‹ä»¶
kubectl get events --sort-by='.lastTimestamp'
```

3. ç½‘ç»œæ•…éšœ
```bash
# æ£€æŸ¥ç½‘ç»œæ’ä»¶
kubectl get pods -n calico-system
kubectl logs -n calico-system calico-node-xxxxx

# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
kubectl exec -it <pod-name> -- ping <target-ip>
```

### æ—¥å¿—æ”¶é›†
```bash
# æ”¶é›†ç³»ç»Ÿæ—¥å¿—
journalctl -u kubelet > kubelet.log
journalctl -u containerd > containerd.log

# æ”¶é›†ç»„ä»¶æ—¥å¿—
kubectl logs -n kube-system kube-apiserver-k8s-master01 > apiserver.log
kubectl logs -n kube-system kube-controller-manager-k8s-master01 > controller-manager.log
kubectl logs -n kube-system kube-scheduler-k8s-master01 > scheduler.log

# æ”¶é›†å®¡è®¡æ—¥å¿—
cat /var/log/kubernetes/audit.log
```

## 9. ç»´æŠ¤ç®¡ç†
### è¯ä¹¦æ›´æ–°
```bash
# æ£€æŸ¥è¯ä¹¦è¿‡æœŸæ—¶é—´
kubeadm certs check-expiration

# æ›´æ–°è¯ä¹¦
kubeadm certs renew all

# é‡å¯ç»„ä»¶
systemctl restart kubelet
```

### ç‰ˆæœ¬å‡çº§
```bash
# å‡çº§kubeadm
apt update
apt install -y kubeadm=1.28.x-00

# å‡çº§æ§åˆ¶å¹³é¢
kubeadm upgrade plan
kubeadm upgrade apply v1.28.x

# å‡çº§kubelet
apt install -y kubelet=1.28.x-00 kubectl=1.28.x-00
systemctl daemon-reload
systemctl restart kubelet
```

### å¤‡ä»½æ¢å¤
```bash
# å¤‡ä»½etcdæ•°æ®
ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key \
  snapshot save snapshot.db

# æ¢å¤etcdæ•°æ®
ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key \
  snapshot restore snapshot.db
```

## 10. æœ€ä½³å®è·µ
### å®‰å…¨å»ºè®®
1. æ§åˆ¶å¹³é¢å®‰å…¨
   - ä½¿ç”¨TLSåŠ å¯†é€šä¿¡
   - å¯ç”¨å®¡è®¡æ—¥å¿—
   - å®šæœŸæ›´æ–°è¯ä¹¦
   - é™åˆ¶APIè®¿é—®

2. èŠ‚ç‚¹å®‰å…¨
   - åŠæ—¶æ›´æ–°ç³»ç»Ÿè¡¥ä¸
   - é™åˆ¶SSHè®¿é—®
   - ç›‘æ§ç³»ç»Ÿæ—¥å¿—
   - é…ç½®é˜²ç«å¢™è§„åˆ™

3. å®¹å™¨å®‰å…¨
   - ä½¿ç”¨æœ€å°åŒ–åŸºç¡€é•œåƒ
   - å®šæœŸæ‰«æå®‰å…¨æ¼æ´
   - é™åˆ¶å®¹å™¨æƒé™
   - é…ç½®ç½‘ç»œç­–ç•¥

### æ€§èƒ½ä¼˜åŒ–
1. èµ„æºé…ç½®
   - åˆç†è®¾ç½®èµ„æºé™åˆ¶
   - ä½¿ç”¨èµ„æºé¢„ç•™
   - é…ç½®HPAè‡ªåŠ¨æ‰©ç¼©
   - ä¼˜åŒ–è°ƒåº¦ç­–ç•¥

2. ç½‘ç»œä¼˜åŒ–
   - ä½¿ç”¨IPVSæ¨¡å¼
   - ä¼˜åŒ–MTUé…ç½®
   - é…ç½®ç½‘ç»œQoS
   - ä½¿ç”¨ç½‘ç»œç­–ç•¥

3. å­˜å‚¨ä¼˜åŒ–
   - é€‰æ‹©åˆé€‚çš„å­˜å‚¨ç±»
   - é…ç½®å­˜å‚¨é™é¢
   - ä½¿ç”¨æœ¬åœ°å­˜å‚¨
   - å®šæœŸæ¸…ç†æ•°æ®

### è¿ç»´å»ºè®®
1. ç›‘æ§å‘Šè­¦
   - éƒ¨ç½²ç›‘æ§ç³»ç»Ÿ
   - é…ç½®å‘Šè­¦è§„åˆ™
   - è®¾ç½®å‘Šè­¦é€šçŸ¥
   - å®šæœŸæ£€æŸ¥ç›‘æ§

2. æ—¥å¿—ç®¡ç†
   - é›†ä¸­åŒ–æ—¥å¿—æ”¶é›†
   - é…ç½®æ—¥å¿—è½®è½¬
   - è®¾ç½®æ—¥å¿—ä¿ç•™
   - åˆ†ææ—¥å¿—æ•°æ®

3. å¤‡ä»½ç­–ç•¥
   - å®šæœŸå¤‡ä»½æ•°æ®
   - æµ‹è¯•æ¢å¤æµç¨‹
   - å¼‚åœ°å¤‡ä»½
   - æ–‡æ¡£åŒ–æ“ä½œ

## ç›¸å…³æ–‡æ¡£
- [æ ¸å¿ƒæ¦‚å¿µç»„ä»¶](./02_æ ¸å¿ƒæ¦‚å¿µç»„ä»¶.md)
- [å·¥ä½œè´Ÿè½½ç®¡ç†](./03_å·¥ä½œè´Ÿè½½ç®¡ç†.md)
- [æœåŠ¡ä¸ç½‘ç»œ](./04_æœåŠ¡ä¸ç½‘ç»œ.md)

## å‚è€ƒèµ„æ–™
1. [Kuberneteså®˜æ–¹æ–‡æ¡£](https://kubernetes.io/docs/)
2. [Kuberneteså®‰è£…æŒ‡å—](https://kubernetes.io/docs/setup/)
3. [Kubernetesæœ€ä½³å®è·µ](https://kubernetes.io/docs/concepts/configuration/overview/)
4. [Kubernetesé›†ç¾¤è¿ç»´](https://kubernetes.io/docs/tasks/administer-cluster/) 