# Kubernetesæ ¸å¿ƒæ¦‚å¿µä¸ç»„ä»¶

## 1. åŸºç¡€ä¿¡æ¯
### æ–‡æ¡£ä¿¡æ¯
- ç‰ˆæœ¬: v1.0.0
- æ›´æ–°æ—¶é—´: 2024-03-21
- çŠ¶æ€: [ğŸ—ï¸è¿›è¡Œä¸­]
- ä½œè€…: System Admin

### ä¿®è®¢å†å²
| ç‰ˆæœ¬ | æ—¥æœŸ | æè¿° | ä½œè€… |
|-----|------|-----|-----|
| v1.0.0 | 2024-03-21 | åˆå§‹ç‰ˆæœ¬ | System Admin |

## 2. æ¶æ„æ¦‚è¿°

### 2.1 æ•´ä½“æ¶æ„
Kubernetesé‡‡ç”¨ä¸»ä»æ¶æ„(Master-Worker)è®¾è®¡:

- MasterèŠ‚ç‚¹(æ§åˆ¶å¹³é¢)
  - API Server: é›†ç¾¤ç»Ÿä¸€å…¥å£,æä¾›REST API
  - Controller Manager: ç»´æŠ¤é›†ç¾¤çŠ¶æ€
  - Scheduler: èµ„æºè°ƒåº¦å†³ç­–
  - etcd: åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨

- WorkerèŠ‚ç‚¹(æ•°æ®å¹³é¢) 
  - kubelet: èŠ‚ç‚¹ä»£ç†,ç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸ
  - kube-proxy: ç½‘ç»œä»£ç†,ç»´æŠ¤ç½‘ç»œè§„åˆ™
  - Container Runtime: å®¹å™¨è¿è¡Œæ—¶(å¦‚containerd)

### 2.2 ç»„ä»¶é€šä¿¡
```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   kubectl    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Control Plane                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚API Serverâ”‚ â”‚ Schedulerâ”‚  â”‚Controller  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  Manager   â”‚  â”‚
â”‚        â”‚           â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚           â”‚             â”‚         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚    â”‚            etcd              â”‚       â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚               â”‚
            â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Worker Node                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚kubelet â”‚  â”‚kube-proxy â”‚  â”‚Container â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ Runtime  â”‚  â”‚
â”‚        â”‚           â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚    â”‚           Pods               â”‚       â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 3. APIèµ„æº

### 3.1 èµ„æºå¯¹è±¡
Kubernetesä¸­çš„æ‰€æœ‰å†…å®¹éƒ½è¢«æŠ½è±¡ä¸ºAPIèµ„æºå¯¹è±¡:

1. å·¥ä½œè´Ÿè½½(Workload)
```yaml
# Podç¤ºä¾‹
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  containers:
  - name: nginx
    image: nginx:1.14.2
    ports:
    - containerPort: 80

# Deploymentç¤ºä¾‹  
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
```

2. æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡
```yaml
# Serviceç¤ºä¾‹
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  selector:
    app: nginx
  ports:
  - port: 80
    targetPort: 80
  type: ClusterIP

# Ingressç¤ºä¾‹
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nginx-ingress
spec:
  rules:
  - host: nginx.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-service
            port:
              number: 80
```

3. é…ç½®ä¸å­˜å‚¨
```yaml
# ConfigMapç¤ºä¾‹
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
data:
  nginx.conf: |
    server {
      listen 80;
      server_name localhost;
      location / {
        root /usr/share/nginx/html;
        index index.html;
      }
    }

# PersistentVolumeç¤ºä¾‹
apiVersion: v1
kind: PersistentVolume
metadata:
  name: nginx-pv
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: /data/nginx
```

### 3.2 èµ„æºç®¡ç†
1. å‘½åç©ºé—´éš”ç¦»
```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: production
```

2. èµ„æºé…é¢
```yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: compute-quota
  namespace: production
spec:
  hard:
    requests.cpu: "4"
    requests.memory: 8Gi
    limits.cpu: "8"
    limits.memory: 16Gi
```

3. é™åˆ¶èŒƒå›´
```yaml
apiVersion: v1
kind: LimitRange
metadata:
  name: limit-range
spec:
  limits:
  - default:
      cpu: 500m
      memory: 512Mi
    defaultRequest:
      cpu: 200m
      memory: 256Mi
    type: Container
```

## 4. æ§åˆ¶å™¨(Controller)

### 4.1 æ§åˆ¶å™¨ç±»å‹

1. ReplicaSet
- ç¡®ä¿Podå‰¯æœ¬æ•°é‡ç¬¦åˆé¢„æœŸ
- æ”¯æŒPodçš„æ‰©ç¼©å®¹
- é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨å…³è”Pod

```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: nginx-rs
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
```

2. Deployment
- æä¾›å£°æ˜å¼æ›´æ–°
- æ”¯æŒæ»šåŠ¨æ›´æ–°å’Œå›æ»š
- ç®¡ç†Podå’ŒReplicaSet

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
```

3. StatefulSet
- é€‚ç”¨äºæœ‰çŠ¶æ€åº”ç”¨
- æä¾›ç¨³å®šçš„ç½‘ç»œæ ‡è¯†
- æ”¯æŒæœ‰åºéƒ¨ç½²å’Œæ‰©ç¼©å®¹

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: web
spec:
  serviceName: "nginx"
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
        ports:
        - containerPort: 80
          name: web
        volumeMounts:
        - name: www
          mountPath: /usr/share/nginx/html
  volumeClaimTemplates:
  - metadata:
      name: www
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 1Gi
```

4. DaemonSet
- ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹è¿è¡ŒPodå‰¯æœ¬
- é€‚ç”¨äºç³»ç»Ÿçº§åå°ä»»åŠ¡
- æ”¯æŒèŠ‚ç‚¹äº²å’Œæ€§è°ƒåº¦

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd-elasticsearch
spec:
  selector:
    matchLabels:
      name: fluentd-elasticsearch
  template:
    metadata:
      labels:
        name: fluentd-elasticsearch
    spec:
      containers:
      - name: fluentd-elasticsearch
        image: quay.io/fluentd_elasticsearch/fluentd:v2.5.2
```

### 4.2 æ§åˆ¶å™¨å·¥ä½œåŸç†

1. æ§åˆ¶å¾ªç¯
```
æœŸæœ›çŠ¶æ€ â”€â”€â”€â”€â”€â”€â–º è§‚å¯Ÿå½“å‰çŠ¶æ€
     â–²               â”‚
     â”‚               â”‚
     â”‚               â–¼
  é‡‡å–è¡ŒåŠ¨ â—„â”€â”€â”€â”€ åˆ†æå·®å¼‚
```

2. è°ƒè°è¿‡ç¨‹
- Watch: ç›‘å¬èµ„æºå˜åŒ–
- List: è·å–èµ„æºåˆ—è¡¨
- Process: å¤„ç†èµ„æºå¯¹è±¡
- Update: æ›´æ–°èµ„æºçŠ¶æ€

3. æ§åˆ¶å™¨æ¨¡å¼
```go
for {
    desired := getDesiredState()    // è·å–æœŸæœ›çŠ¶æ€
    current := getCurrentState()    // è·å–å½“å‰çŠ¶æ€
    if desired != current {
        reconcile(desired, current) // è°ƒè°çŠ¶æ€
    }
    sleep(period)                  // ç­‰å¾…ä¸‹ä¸€ä¸ªå‘¨æœŸ
}
```

## 5. è°ƒåº¦å™¨(Scheduler)

### 5.1 è°ƒåº¦æµç¨‹

1. é¢„é€‰(Predicates)
- èŠ‚ç‚¹è¿‡æ»¤
- èµ„æºéœ€æ±‚æ£€æŸ¥
- äº²å’Œæ€§/åäº²å’Œæ€§è§„åˆ™
- æ±¡ç‚¹/å®¹å¿æ£€æŸ¥

2. ä¼˜é€‰(Priorities)
- èŠ‚ç‚¹è¯„åˆ†
- èµ„æºå¹³è¡¡
- äº²å’Œæ€§ä¼˜å…ˆçº§
- æ±¡ç‚¹ä¼˜å…ˆçº§

3. é€‰æ‹©(Select)
- é€‰æ‹©æœ€é«˜åˆ†èŠ‚ç‚¹
- ç»‘å®šPodåˆ°èŠ‚ç‚¹
- æ›´æ–°è°ƒåº¦çŠ¶æ€

### 5.2 è°ƒåº¦ç­–ç•¥

1. èŠ‚ç‚¹é€‰æ‹©å™¨
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  nodeSelector:
    disktype: ssd
  containers:
  - name: nginx
    image: nginx:1.14.2
```

2. èŠ‚ç‚¹äº²å’Œæ€§
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: kubernetes.io/e2e-az-name
            operator: In
            values:
            - e2e-az1
            - e2e-az2
  containers:
  - name: nginx
    image: nginx:1.14.2
```

3. Podäº²å’Œæ€§
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  affinity:
    podAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
          - key: security
            operator: In
            values:
            - S1
        topologyKey: topology.kubernetes.io/zone
  containers:
  - name: nginx
    image: nginx:1.14.2
```

4. æ±¡ç‚¹å’Œå®¹å¿
```yaml
# èŠ‚ç‚¹æ±¡ç‚¹
kubectl taint nodes node1 key=value:NoSchedule

# Podå®¹å¿
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  tolerations:
  - key: "key"
    operator: "Equal"
    value: "value"
    effect: "NoSchedule"
  containers:
  - name: nginx
    image: nginx:1.14.2
```

### 5.3 è‡ªå®šä¹‰è°ƒåº¦å™¨

1. æ‰©å±•ç‚¹
- é¢„é€‰æ‰©å±•
- ä¼˜é€‰æ‰©å±•
- ç»‘å®šæ‰©å±•
- æŠ¢å æ‰©å±•

2. è°ƒåº¦æ¡†æ¶
```yaml
apiVersion: kubescheduler.config.k8s.io/v1
kind: KubeSchedulerConfiguration
profiles:
- schedulerName: custom-scheduler
  plugins:
    score:
      disabled:
      - name: NodeResourcesBalancedAllocation
      enabled:
      - name: CustomScorePlugin
        weight: 3
```

## 6. èµ„æºç®¡ç†

### 6.1 èµ„æºç±»å‹

1. è®¡ç®—èµ„æº
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: frontend
spec:
  containers:
  - name: app
    image: images.my-company.example/app:v4
    resources:
      requests:
        memory: "64Mi"
        cpu: "250m"
      limits:
        memory: "128Mi"
        cpu: "500m"
```

2. å­˜å‚¨èµ„æº
```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pv-claim
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
```

3. ç½‘ç»œèµ„æº
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: test-network-policy
spec:
  podSelector:
    matchLabels:
      role: db
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - ipBlock:
        cidr: 172.17.0.0/16
        except:
        - 172.17.1.0/24
    ports:
    - protocol: TCP
      port: 6379
```

### 6.2 èµ„æºé…é¢

1. å‘½åç©ºé—´é…é¢
```yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: compute-resources
spec:
  hard:
    requests.cpu: "4"
    requests.memory: 8Gi
    limits.cpu: "8"
    limits.memory: 16Gi
    requests.nvidia.com/gpu: 4
```

2. å¯¹è±¡é…é¢
```yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: object-counts
spec:
  hard:
    configmaps: "10"
    persistentvolumeclaims: "4"
    replicationcontrollers: "20"
    secrets: "10"
    services: "10"
    services.loadbalancers: "2"
```

### 6.3 æœåŠ¡è´¨é‡(QoS)

1. Guaranteed
- è¯·æ±‚ç­‰äºé™åˆ¶
- æœ€é«˜ä¼˜å…ˆçº§
- ä¸ä¼šè¢«é©±é€

2. Burstable
- è¯·æ±‚å°äºé™åˆ¶
- ä¸­ç­‰ä¼˜å…ˆçº§
- å¯èƒ½è¢«é©±é€

3. BestEffort
- æ— è¯·æ±‚å’Œé™åˆ¶
- æœ€ä½ä¼˜å…ˆçº§
- æœ€å…ˆè¢«é©±é€

## 7. æœ€ä½³å®è·µ

### 7.1 èµ„æºè§„åˆ’

1. å®¹é‡è§„åˆ’
- è¯„ä¼°å·¥ä½œè´Ÿè½½
- é¢„ç•™ç³»ç»Ÿèµ„æº
- è€ƒè™‘é«˜å¯ç”¨éœ€æ±‚
- è§„åˆ’æ‰©å±•ç­–ç•¥

2. èµ„æºé™åˆ¶
- è®¾ç½®åˆç†çš„è¯·æ±‚å’Œé™åˆ¶
- é¿å…èµ„æºè¿‡åº¦åˆ†é…
- ç›‘æ§èµ„æºä½¿ç”¨æƒ…å†µ
- åŠæ—¶è°ƒæ•´é…ç½®

3. é«˜å¯ç”¨è®¾è®¡
- å¤šå‰¯æœ¬éƒ¨ç½²
- åäº²å’Œæ€§è°ƒåº¦
- åˆç†çš„èµ„æºé¢„ç•™
- å®šæœŸå¤‡ä»½æ•°æ®

### 7.2 æ€§èƒ½ä¼˜åŒ–

1. è°ƒåº¦ä¼˜åŒ–
- ä½¿ç”¨èŠ‚ç‚¹æ ‡ç­¾
- é…ç½®äº²å’Œæ€§è§„åˆ™
- åˆç†è®¾ç½®ä¼˜å…ˆçº§
- é¿å…èµ„æºç¢ç‰‡

2. èµ„æºåˆ©ç”¨
- åˆç†è®¾ç½®QoSç­‰çº§
- ä½¿ç”¨æ°´å¹³è‡ªåŠ¨æ‰©ç¼©
- ä¼˜åŒ–èµ„æºè¯·æ±‚
- æ¸…ç†æœªä½¿ç”¨èµ„æº

3. ç›‘æ§å‘Šè­¦
- éƒ¨ç½²ç›‘æ§ç³»ç»Ÿ
- è®¾ç½®èµ„æºé˜ˆå€¼
- é…ç½®å‘Šè­¦è§„åˆ™
- åŠæ—¶å“åº”é—®é¢˜

## ç›¸å…³æ–‡æ¡£
- [é›†ç¾¤éƒ¨ç½²é…ç½®](./01_é›†ç¾¤éƒ¨ç½²é…ç½®.md)
- [å·¥ä½œè´Ÿè½½ç®¡ç†](./03_å·¥ä½œè´Ÿè½½ç®¡ç†.md)
- [æœåŠ¡ä¸ç½‘ç»œ](./04_æœåŠ¡ä¸ç½‘ç»œ.md)

## å‚è€ƒèµ„æ–™
1. [Kubernetesæ–‡æ¡£](https://kubernetes.io/docs/concepts/)
2. [Kubernetes API](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.28/)
3. [Kubernetesè®¾è®¡æ–‡æ¡£](https://github.com/kubernetes/community/tree/master/contributors/design-proposals)
4. [Kubernetesæºç ](https://github.com/kubernetes/kubernetes) 