# Kubernetesç¯å¢ƒå˜é‡é…ç½®

## æ–‡æ¡£ä¿¡æ¯
- ç‰ˆæœ¬: v1.0.0
- æ›´æ–°æ—¶é—´: 2024-03-21
- çŠ¶æ€: [ğŸ—ï¸è¿›è¡Œä¸­]
- ä½œè€…: System Admin

## ä¿®è®¢å†å²
| ç‰ˆæœ¬ | æ—¥æœŸ | æè¿° | ä½œè€… |
|-----|------|-----|-----|
| v1.0.0 | 2024-03-21 | åˆå§‹ç‰ˆæœ¬ | System Admin |

## æ–‡æ¡£è¯´æ˜
### ç›®æ ‡è¯»è€…
- Kubernetesç®¡ç†å‘˜
- åº”ç”¨å¼€å‘äººå‘˜
- DevOpså·¥ç¨‹å¸ˆ
- å¹³å°è¿ç»´äººå‘˜

### å‰ç½®çŸ¥è¯†
- KubernetesåŸºç¡€æ¦‚å¿µ
- å®¹å™¨æŠ€æœ¯åŸºç¡€
- Linuxç¯å¢ƒå˜é‡
- Shellè„šæœ¬åŸºç¡€

## ç¯å¢ƒå˜é‡æ¦‚è¿°
### åŸºæœ¬æ¦‚å¿µ
1. å®šä¹‰
   - å®¹å™¨è¿è¡Œæ—¶çš„é…ç½®
   - é”®å€¼å¯¹å½¢å¼
   - è¿è¡Œæ—¶å¯è®¿é—®
   - æ”¯æŒåŠ¨æ€æ›´æ–°

2. æ¥æº
   - ç›´æ¥å®šä¹‰
   - ConfigMapå¼•ç”¨
   - Secretå¼•ç”¨
   - å­—æ®µå¼•ç”¨
   - èµ„æºå¼•ç”¨

3. ç‰¹æ€§
   - å®¹å™¨çº§åˆ«éš”ç¦»
   - è¿è¡Œæ—¶ç”Ÿæ•ˆ
   - æ”¯æŒåŠ å¯†æ•°æ®
   - æ”¯æŒåŠ¨æ€æ›´æ–°

## ç¯å¢ƒå˜é‡é…ç½®
### ç›´æ¥å®šä¹‰
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: env-pod
spec:
  containers:
  - name: env-container
    image: nginx:1.14.2
    env:
    - name: APP_NAME
      value: "my-app"
    - name: APP_VERSION
      value: "1.0.0"
    - name: DEBUG_LEVEL
      value: "info"
```

### ConfigMapå¼•ç”¨
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  APP_NAME: "my-app"
  APP_VERSION: "1.0.0"
  APP_CONFIG: |
    {
      "key1": "value1",
      "key2": "value2"
    }

---
apiVersion: v1
kind: Pod
metadata:
  name: configmap-env-pod
spec:
  containers:
  - name: app-container
    image: myapp:1.0
    env:
    # å•ä¸ªå˜é‡å¼•ç”¨
    - name: APPLICATION_NAME
      valueFrom:
        configMapKeyRef:
          name: app-config
          key: APP_NAME
    # å…¨éƒ¨å˜é‡å¼•ç”¨
    envFrom:
    - configMapRef:
        name: app-config
```

### Secretå¼•ç”¨
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
type: Opaque
data:
  DB_USER: YWRtaW4=
  DB_PASS: cGFzc3dvcmQ=

---
apiVersion: v1
kind: Pod
metadata:
  name: secret-env-pod
spec:
  containers:
  - name: app-container
    image: myapp:1.0
    env:
    # å•ä¸ªå˜é‡å¼•ç”¨
    - name: DATABASE_USER
      valueFrom:
        secretKeyRef:
          name: app-secrets
          key: DB_USER
    # å…¨éƒ¨å˜é‡å¼•ç”¨
    envFrom:
    - secretRef:
        name: app-secrets
```

### å­—æ®µå¼•ç”¨
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: field-env-pod
spec:
  containers:
  - name: app-container
    image: myapp:1.0
    env:
    - name: POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
    - name: POD_NAMESPACE
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace
    - name: POD_IP
      valueFrom:
        fieldRef:
          fieldPath: status.podIP
    - name: NODE_NAME
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName
```

### èµ„æºå¼•ç”¨
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: resource-env-pod
spec:
  containers:
  - name: app-container
    image: myapp:1.0
    env:
    - name: CPU_LIMIT
      valueFrom:
        resourceFieldRef:
          containerName: app-container
          resource: limits.cpu
    - name: MEMORY_LIMIT
      valueFrom:
        resourceFieldRef:
          containerName: app-container
          resource: limits.memory
    resources:
      limits:
        cpu: "1"
        memory: "512Mi"
      requests:
        cpu: "0.5"
        memory: "256Mi"
```

## æœ€ä½³å®è·µ
### ç¯å¢ƒåˆ†ç¦»
1. å¼€å‘ç¯å¢ƒ
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config-dev
data:
  APP_ENV: "development"
  LOG_LEVEL: "debug"
  API_URL: "http://api-dev.example.com"
```

2. ç”Ÿäº§ç¯å¢ƒ
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config-prod
data:
  APP_ENV: "production"
  LOG_LEVEL: "info"
  API_URL: "http://api.example.com"
```

3. ç¯å¢ƒé€‰æ‹©
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: app-pod
spec:
  containers:
  - name: app-container
    image: myapp:1.0
    envFrom:
    - configMapRef:
        name: app-config-prod
```

### åŠ¨æ€æ›´æ–°
1. é…ç½®æ›´æ–°
```yaml
apiVersion: v1
kind: Deployment
metadata:
  name: app-deployment
spec:
  template:
    metadata:
      annotations:
        # æ·»åŠ ç‰ˆæœ¬æ³¨è§£è§¦å‘æ›´æ–°
        config.version: "v1"
    spec:
      containers:
      - name: app-container
        image: myapp:1.0
        envFrom:
        - configMapRef:
            name: app-config
```

2. é‡è½½å¤„ç†
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: app-pod
spec:
  containers:
  - name: app-container
    image: myapp:1.0
    env:
    - name: CONFIG_VERSION
      valueFrom:
        configMapKeyRef:
          name: app-config
          key: version
    lifecycle:
      postStart:
        exec:
          command: ["/bin/sh", "-c", "config-reload.sh"]
```

### æ•æ„Ÿä¿¡æ¯å¤„ç†
1. ä½¿ç”¨Secret
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: app-credentials
type: Opaque
stringData:
  credentials.env: |
    DB_USER=admin
    DB_PASS=password
    API_KEY=1234567890
```

2. ç¯å¢ƒå˜é‡å¼•ç”¨
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: secure-pod
spec:
  containers:
  - name: app-container
    image: myapp:1.0
    envFrom:
    - secretRef:
        name: app-credentials
    env:
    - name: DB_CONNECTION_STRING
      value: "postgresql://$(DB_USER):$(DB_PASS)@db:5432/mydb"
```

## æ•…éšœæ’æŸ¥
### å¸¸è§é—®é¢˜
1. å˜é‡ä¸å¯è§
   - æ£€æŸ¥å˜é‡å®šä¹‰
   - éªŒè¯å¼•ç”¨é…ç½®
   - ç¡®è®¤å‘½åç©ºé—´
   - æ£€æŸ¥æƒé™è®¾ç½®

2. æ›´æ–°ä¸ç”Ÿæ•ˆ
   - æ£€æŸ¥Podé‡å¯
   - éªŒè¯é…ç½®æ›´æ–°
   - ç¡®è®¤å¼•ç”¨æ–¹å¼
   - æ£€æŸ¥é‡è½½æœºåˆ¶

3. æ ¼å¼é—®é¢˜
   - æ£€æŸ¥è¯­æ³•é”™è¯¯
   - éªŒè¯å€¼æ ¼å¼
   - ç¡®è®¤ç¼–ç æ­£ç¡®
   - æ£€æŸ¥ç‰¹æ®Šå­—ç¬¦

### æ’æŸ¥å‘½ä»¤
```bash
# æŸ¥çœ‹ç¯å¢ƒå˜é‡
kubectl exec pod-name -- env

# æ£€æŸ¥ConfigMap
kubectl get configmap app-config -o yaml

# æ£€æŸ¥Secret
kubectl get secret app-secrets -o yaml

# æŸ¥çœ‹Podè¯¦æƒ…
kubectl describe pod pod-name

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
kubectl logs pod-name
```

## å®‰å…¨å»ºè®®
1. æ•æ„Ÿä¿¡æ¯ä¿æŠ¤
   - ä½¿ç”¨Secretå­˜å‚¨
   - åŠ å¯†ä¼ è¾“
   - æœ€å°æƒé™è®¿é—®
   - å®šæœŸè½®æ¢å¯†é’¥

2. è®¿é—®æ§åˆ¶
   - RBACæƒé™æ§åˆ¶
   - å‘½åç©ºé—´éš”ç¦»
   - å®¡è®¡æ—¥å¿—è®°å½•
   - ç›‘æ§å¼‚å¸¸è®¿é—®

3. é…ç½®ç®¡ç†
   - ç‰ˆæœ¬æ§åˆ¶
   - ç¯å¢ƒéš”ç¦»
   - å˜æ›´å®¡è®¡
   - å¤‡ä»½æ¢å¤

## ç›‘æ§å’Œå®¡è®¡
1. ç›‘æ§æŒ‡æ ‡
```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: env-monitor
spec:
  selector:
    matchLabels:
      app: myapp
  endpoints:
  - port: metrics
```

2. å®¡è®¡ç­–ç•¥
```yaml
apiVersion: audit.k8s.io/v1
kind: Policy
rules:
- level: Metadata
  resources:
  - group: ""
    resources: ["configmaps", "secrets"]
```

## å‚è€ƒèµ„æ–™
- [Kubernetesç¯å¢ƒå˜é‡](https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container/)
- [ConfigMapå’ŒSecret](https://kubernetes.io/docs/concepts/configuration/)
- [Podé…ç½®æœ€ä½³å®è·µ](https://kubernetes.io/docs/concepts/configuration/overview/)

## ç›¸å…³æ–‡æ¡£
- [ConfigMapé…ç½®](./01_ConfigMapé…ç½®ç®¡ç†.md)
- [Secretç®¡ç†](./02_Secretç®¡ç†.md)
- [Podé…ç½®](../03_å·¥ä½œè´Ÿè½½ç®¡ç†/01_Podç®¡ç†.md)
``` 