# Kubernetesç½‘ç»œç­–ç•¥

## æ–‡æ¡£ä¿¡æ¯
- ç‰ˆæœ¬: v1.0.0
- æ›´æ–°æ—¶é—´: 2024-03-21
- çŠ¶æ€: [ğŸ—ï¸è¿›è¡Œä¸­]
- ä½œè€…: System Admin

## ä¿®è®¢å†å²
| ç‰ˆæœ¬ | æ—¥æœŸ | æè¿° | ä½œè€… |
|-----|------|-----|-----|
| v1.0.0 | 2024-03-21 | åˆå§‹ç‰ˆæœ¬ | System Admin |

## æ–‡æ¡£è¯´æ˜
### ç›®æ ‡è¯»è€…
- Kubernetesç®¡ç†å‘˜
- å®‰å…¨å·¥ç¨‹å¸ˆ
- DevOpså·¥ç¨‹å¸ˆ
- å¹³å°è¿ç»´äººå‘˜

### å‰ç½®çŸ¥è¯†
- KubernetesåŸºç¡€æ¦‚å¿µ
- ç½‘ç»œåŸºç¡€çŸ¥è¯†
- å®‰å…¨åŸºç¡€çŸ¥è¯†
- CNIæ’ä»¶åŸºç¡€

## ç½‘ç»œç­–ç•¥æ¦‚è¿°
### åŸºæœ¬æ¦‚å¿µ
1. å®šä¹‰
   - ç½‘ç»œè®¿é—®æ§åˆ¶
   - åŸºäºæ ‡ç­¾é€‰æ‹©
   - å‘½åç©ºé—´éš”ç¦»
   - æµé‡æ§åˆ¶è§„åˆ™

2. åŠŸèƒ½
   - å…¥ç«™è§„åˆ™æ§åˆ¶
   - å‡ºç«™è§„åˆ™æ§åˆ¶
   - Podéš”ç¦»ç­–ç•¥
   - ç½‘ç»œåˆ†æ®µç®¡ç†

3. ç‰¹æ€§
   - å£°æ˜å¼é…ç½®
   - ç»†ç²’åº¦æ§åˆ¶
   - åŠ¨æ€æ›´æ–°
   - å¤šCNIæ”¯æŒ

## ç­–ç•¥ç±»å‹
### é»˜è®¤ç­–ç•¥
1. é»˜è®¤æ‹’ç»æ‰€æœ‰å…¥ç«™æµé‡
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
spec:
  podSelector: {}
  policyTypes:
  - Ingress
```

2. é»˜è®¤æ‹’ç»æ‰€æœ‰å‡ºç«™æµé‡
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-egress
spec:
  podSelector: {}
  policyTypes:
  - Egress
```

3. é»˜è®¤å…è®¸æ‰€æœ‰æµé‡
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-all
spec:
  podSelector: {}
  ingress:
  - {}
  egress:
  - {}
  policyTypes:
  - Ingress
  - Egress
```

### é€‰æ‹©å™¨ç­–ç•¥
1. Podé€‰æ‹©å™¨
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: pod-policy
spec:
  podSelector:
    matchLabels:
      app: web
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: api
```

2. å‘½åç©ºé—´é€‰æ‹©å™¨
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ns-policy
spec:
  podSelector:
    matchLabels:
      app: web
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          environment: production
```

## å…¥ç«™è§„åˆ™
### åŸºæœ¬é…ç½®
1. å•ä¸€è§„åˆ™
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ingress-policy
spec:
  podSelector:
    matchLabels:
      app: web
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: frontend
    ports:
    - protocol: TCP
      port: 80
```

2. å¤šè§„åˆ™ç»„åˆ
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: multi-ingress-policy
spec:
  podSelector:
    matchLabels:
      app: web
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: frontend
    - namespaceSelector:
        matchLabels:
          environment: production
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443
```

### é«˜çº§é…ç½®
1. IPå—é€‰æ‹©å™¨
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ipblock-policy
spec:
  podSelector:
    matchLabels:
      app: web
  policyTypes:
  - Ingress
  ingress:
  - from:
    - ipBlock:
        cidr: 172.17.0.0/16
        except:
        - 172.17.1.0/24
```

2. å¤åˆé€‰æ‹©å™¨
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: complex-policy
spec:
  podSelector:
    matchLabels:
      app: web
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          environment: production
      podSelector:
        matchLabels:
          app: frontend
```

## å‡ºç«™è§„åˆ™
### åŸºæœ¬é…ç½®
1. å•ä¸€è§„åˆ™
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: egress-policy
spec:
  podSelector:
    matchLabels:
      app: web
  policyTypes:
  - Egress
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: db
    ports:
    - protocol: TCP
      port: 5432
```

2. å¤šè§„åˆ™ç»„åˆ
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: multi-egress-policy
spec:
  podSelector:
    matchLabels:
      app: web
  policyTypes:
  - Egress
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: db
    ports:
    - protocol: TCP
      port: 5432
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
```

### é«˜çº§é…ç½®
1. DNSè®¿é—®
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: dns-policy
spec:
  podSelector:
    matchLabels:
      app: web
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
```

2. å¤–éƒ¨è®¿é—®
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: external-policy
spec:
  podSelector:
    matchLabels:
      app: web
  policyTypes:
  - Egress
  egress:
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
        except:
        - 10.0.0.0/8
        - 172.16.0.0/12
        - 192.168.0.0/16
```

## æœ€ä½³å®è·µ
### å®‰å…¨ç­–ç•¥
1. é»˜è®¤æ‹’ç»
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
```

2. ç™½åå•æœºåˆ¶
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: whitelist-policy
spec:
  podSelector:
    matchLabels:
      app: web
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          approved: "true"
  egress:
  - to:
    - podSelector:
        matchLabels:
          approved: "true"
```

### éš”ç¦»ç­–ç•¥
1. ç¯å¢ƒéš”ç¦»
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: env-isolation
spec:
  podSelector:
    matchLabels:
      environment: production
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          environment: production
```

2. åº”ç”¨éš”ç¦»
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: app-isolation
spec:
  podSelector:
    matchLabels:
      app: web
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          tier: frontend
  egress:
  - to:
    - podSelector:
        matchLabels:
          tier: backend
```

## ç›‘æ§å’Œå®¡è®¡
### ç›‘æ§é…ç½®
1. ç­–ç•¥ç›‘æ§
```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: network-policy-monitor
spec:
  selector:
    matchLabels:
      k8s-app: cilium
  endpoints:
  - port: metrics
```

2. æµé‡ç›‘æ§
```yaml
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: flow-visibility
spec:
  endpointSelector:
    matchLabels:
      app: web
  ingress:
  - fromEndpoints:
    - matchLabels:
        app: frontend
    toPorts:
    - ports:
      - port: "80"
        protocol: TCP
      rules:
        http:
        - method: "GET"
          path: "/api/.*"
```

### å®¡è®¡é…ç½®
1. ç­–ç•¥å®¡è®¡
```yaml
apiVersion: audit.k8s.io/v1
kind: Policy
rules:
- level: Metadata
  resources:
  - group: networking.k8s.io
    resources: ["networkpolicies"]
```

2. æµé‡å®¡è®¡
```yaml
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: audit-policy
spec:
  endpointSelector:
    matchLabels:
      app: web
  egress:
  - toEndpoints:
    - matchLabels:
        app: db
    toPorts:
    - ports:
      - port: "5432"
        protocol: TCP
      rules:
        postgres:
        - query: "SELECT.*"
```

## æ•…éšœæ’æŸ¥
### å¸¸è§é—®é¢˜
1. ç­–ç•¥é—®é¢˜
   - é€‰æ‹©å™¨åŒ¹é…å¤±è´¥
   - è§„åˆ™å†²çª
   - CNIå…¼å®¹æ€§
   - å‘½åç©ºé—´éš”ç¦»

2. è¿æ¥é—®é¢˜
   - DNSè§£æå¤±è´¥
   - ç«¯å£è®¿é—®å—é™
   - åè®®ä¸åŒ¹é…
   - è·¯ç”±é—®é¢˜

3. æ€§èƒ½é—®é¢˜
   - è§„åˆ™è¿‡å¤š
   - èµ„æºæ¶ˆè€—
   - å»¶è¿Ÿå¢åŠ 
   - è¿æ¥ä¸­æ–­

### æ’æŸ¥å‘½ä»¤
```bash
# æ£€æŸ¥ç½‘ç»œç­–ç•¥
kubectl get networkpolicies
kubectl describe networkpolicy <policy-name>

# æ£€æŸ¥Podæ ‡ç­¾
kubectl get pods --show-labels
kubectl describe pod <pod-name>

# æ£€æŸ¥è¿æ¥
kubectl exec -it <pod-name> -- nc -zv <target-pod> <port>
kubectl exec -it <pod-name> -- curl <service-name>

# æ£€æŸ¥CNI
kubectl get pods -n kube-system | grep cni
kubectl logs -n kube-system <cni-pod>
```

## æœ€ä½³å®è·µ
1. ç­–ç•¥è®¾è®¡
   - æœ€å°æƒé™åŸåˆ™
   - åˆ†å±‚é˜²æŠ¤
   - æ¸…æ™°çš„æ ‡ç­¾ä½“ç³»
   - åˆç†çš„è§„åˆ™ç»„ç»‡

2. å®‰å…¨åŠ å›º
   - é»˜è®¤æ‹’ç»ç­–ç•¥
   - ç™½åå•æœºåˆ¶
   - ç¯å¢ƒéš”ç¦»
   - å®šæœŸå®¡è®¡

3. è¿ç»´ç®¡ç†
   - ç‰ˆæœ¬æ§åˆ¶
   - å˜æ›´ç®¡ç†
   - ç›‘æ§å‘Šè­¦
   - åº”æ€¥å“åº”

4. æ€§èƒ½ä¼˜åŒ–
   - è§„åˆ™ç®€åŒ–
   - ç¼“å­˜ä¼˜åŒ–
   - èµ„æºé¢„ç•™
   - å®šæœŸæ¸…ç†

## å‚è€ƒèµ„æ–™
- [Kubernetesç½‘ç»œç­–ç•¥](https://kubernetes.io/docs/concepts/services-networking/network-policies/)
- [Calicoç½‘ç»œç­–ç•¥](https://docs.projectcalico.org/security/network-policy)
- [Ciliumç½‘ç»œç­–ç•¥](https://docs.cilium.io/en/stable/policy/)

## ç›¸å…³æ–‡æ¡£
- [ç½‘ç»œåŸºç¡€æ¦‚å¿µ](./01_ç½‘ç»œåŸºç¡€æ¦‚å¿µ.md)
- [CNIæ’ä»¶é…ç½®](./02_CNIæ’ä»¶é…ç½®.md)
- [ServiceæœåŠ¡](./03_ServiceæœåŠ¡.md)
``` 