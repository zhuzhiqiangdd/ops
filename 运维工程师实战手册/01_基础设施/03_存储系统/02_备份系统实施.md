# å¤‡ä»½ç³»ç»Ÿå®æ–½

## æ–‡æ¡£ä¿¡æ¯
- ç‰ˆæœ¬: v1.0.0
- æ›´æ–°æ—¶é—´: 2024-03-21
- çŠ¶æ€: [ğŸ—ï¸è¿›è¡Œä¸­]
- ä½œè€…: System Admin

## ä¿®è®¢å†å²
| ç‰ˆæœ¬ | æ—¥æœŸ | æè¿° | ä½œè€… |
|-----|------|-----|-----|
| v1.0.0 | 2024-03-21 | åˆå§‹ç‰ˆæœ¬ | System Admin |

## æ–‡æ¡£è¯´æ˜
### ç›®æ ‡è¯»è€…
- ç³»ç»Ÿç®¡ç†å‘˜
- è¿ç»´å·¥ç¨‹å¸ˆ
- å­˜å‚¨å·¥ç¨‹å¸ˆ
- æ•°æ®ç®¡ç†å‘˜

### å‰ç½®çŸ¥è¯†
- å­˜å‚¨ç³»ç»ŸåŸºç¡€
- å¤‡ä»½æŠ€æœ¯åŸç†
- Linuxç³»ç»Ÿç®¡ç†
- ç½‘ç»œå­˜å‚¨çŸ¥è¯†

## å¤‡ä»½ç³»ç»Ÿæ¦‚è¿°
### å¤‡ä»½ç±»å‹
1. æŒ‰å¤‡ä»½èŒƒå›´
   - å®Œæ•´å¤‡ä»½
   - å¢é‡å¤‡ä»½
   - å·®å¼‚å¤‡ä»½
   - å¿«ç…§å¤‡ä»½

2. æŒ‰å¤‡ä»½æ–¹å¼
   - ç‰©ç†å¤‡ä»½
   - é€»è¾‘å¤‡ä»½
   - åœ¨çº¿å¤‡ä»½
   - ç¦»çº¿å¤‡ä»½

3. æŒ‰å­˜å‚¨ä»‹è´¨
   - ç£ç›˜å¤‡ä»½
   - ç£å¸¦å¤‡ä»½
   - äº‘ç«¯å¤‡ä»½
   - æ··åˆå¤‡ä»½

### å¤‡ä»½ç­–ç•¥
1. æ—¶é—´ç­–ç•¥
   - æ¯æ—¥å¤‡ä»½
   - æ¯å‘¨å¤‡ä»½
   - æ¯æœˆå¤‡ä»½
   - å¹´åº¦å¤‡ä»½

2. ä¿ç•™ç­–ç•¥
   - ä¿ç•™å‘¨æœŸ
   - ç‰ˆæœ¬æ•°é‡
   - å­˜å‚¨é™åˆ¶
   - æ¸…ç†ç­–ç•¥

## å¤‡ä»½å·¥å…·é…ç½®
### rsyncé…ç½®
```bash
# åŸºæœ¬é…ç½®
# /etc/rsyncd.conf
uid = root
gid = root
use chroot = yes
max connections = 10
pid file = /var/run/rsyncd.pid
log file = /var/log/rsyncd.log

[backup]
    path = /backup
    read only = no
    auth users = backup
    secrets file = /etc/rsyncd.secrets
    hosts allow = 192.168.1.0/24

# åˆ›å»ºå¯†ç æ–‡ä»¶
echo "backup:password" > /etc/rsyncd.secrets
chmod 600 /etc/rsyncd.secrets

# å¯åŠ¨æœåŠ¡
systemctl start rsyncd
systemctl enable rsyncd
```

### Baculaé…ç½®
```ini
# /etc/bacula/bacula-dir.conf
Director {
  Name = backup-dir
  DIRport = 9101
  QueryFile = "/etc/bacula/scripts/query.sql"
  WorkingDirectory = "/var/lib/bacula"
  PidDirectory = "/var/run"
  Maximum Concurrent Jobs = 20
  Password = "backup-password"
  Messages = Daemon
}

# å­˜å‚¨è®¾å¤‡é…ç½®
Storage {
  Name = File-Storage
  Address = localhost
  SDPort = 9103
  Password = "storage-password"
  Device = FileStorage
  Media Type = File
}

# æ–‡ä»¶é›†é…ç½®
FileSet {
  Name = "Full Set"
  Include {
    Options {
      signature = MD5
      compression = GZIP
    }
    File = /etc
    File = /home
    File = /var/www
  }
  Exclude {
    File = /var/lib/bacula
    File = /tmp
    File = /proc
    File = /sys
  }
}

# ä»»åŠ¡é…ç½®
Job {
  Name = "BackupServer"
  Type = Backup
  Level = Full
  FileSet = "Full Set"
  Schedule = "WeeklyCycle"
  Storage = File-Storage
  Messages = Standard
  Pool = File
  Priority = 10
  Write Bootstrap = "/var/lib/bacula/BackupServer.bsr"
}
```

### Amandaé…ç½®
```ini
# /etc/amanda/DailySet/amanda.conf
org "DailyBackup"
mailto "admin@example.com"
dumpuser "backup"

holdingdisk hd1 {
    comment "Main Holding Disk"
    directory "/var/lib/amanda/holdings"
    use 80G
    chunksize 1G
}

define dumptype global {
    compress client
    index yes
}

define tapetype LTO4 {
    length 800G
    filemark 4096
}

define policy daily {
    retention days 4 weeks
}

define storage local_storage {
    tpchanger "chg-disk:/backup/vtapes"
    policy "daily"
}
```

## å¤‡ä»½å®æ–½æ–¹æ¡ˆ
### æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½
1. å®šæ—¶å¤‡ä»½è„šæœ¬
```bash
#!/bin/bash
# å¤‡ä»½é…ç½®
BACKUP_DIR="/backup"
DATE=$(date +%Y%m%d)
RETENTION_DAYS=7

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR/$DATE

# æ‰§è¡Œå¤‡ä»½
rsync -avz --delete /etc $BACKUP_DIR/$DATE/
rsync -avz --delete /home $BACKUP_DIR/$DATE/
rsync -avz --delete /var/www $BACKUP_DIR/$DATE/

# å‹ç¼©å¤‡ä»½
cd $BACKUP_DIR
tar czf backup_$DATE.tar.gz $DATE/
rm -rf $DATE/

# æ¸…ç†æ—§å¤‡ä»½
find $BACKUP_DIR -name "backup_*.tar.gz" -mtime +$RETENTION_DAYS -delete
```

2. å¿«ç…§å¤‡ä»½
```bash
# LVMå¿«ç…§
lvcreate -L 10G -s -n snap_root /dev/vg_system/lv_root

# ZFSå¿«ç…§
zfs snapshot tank/data@backup_$(date +%Y%m%d)

# å¿«ç…§å¤‡ä»½
rsync -avz --delete /dev/vg_system/snap_root/ /backup/
lvremove -f /dev/vg_system/snap_root
```

### æ•°æ®åº“å¤‡ä»½
1. MySQLå¤‡ä»½
```bash
#!/bin/bash
# MySQLå¤‡ä»½é…ç½®
MYSQL_USER="backup"
MYSQL_PASS="password"
BACKUP_DIR="/backup/mysql"
DATE=$(date +%Y%m%d)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR/$DATE

# å®Œæ•´å¤‡ä»½
mysqldump -u$MYSQL_USER -p$MYSQL_PASS --all-databases \
    --single-transaction \
    --master-data=2 \
    --triggers \
    --routines \
    --events \
    | gzip > $BACKUP_DIR/$DATE/full_backup.sql.gz

# äºŒè¿›åˆ¶æ—¥å¿—å¤‡ä»½
mysqlbinlog --raw \
    --read-from-remote-server \
    --stop-never \
    --host=localhost \
    --user=$MYSQL_USER \
    --password=$MYSQL_PASS \
    mysql-bin.000001
```

2. PostgreSQLå¤‡ä»½
```bash
#!/bin/bash
# PostgreSQLå¤‡ä»½é…ç½®
PGUSER="postgres"
BACKUP_DIR="/backup/postgresql"
DATE=$(date +%Y%m%d)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR/$DATE

# å®Œæ•´å¤‡ä»½
pg_dumpall -U $PGUSER | gzip > $BACKUP_DIR/$DATE/full_backup.sql.gz

# WALå½’æ¡£
archive_command = 'test ! -f /backup/postgresql/wal/%f && cp %p /backup/postgresql/wal/%f'
```

### ç³»ç»Ÿå¤‡ä»½
1. ç³»ç»Ÿé•œåƒ
```bash
# ä½¿ç”¨ddåˆ›å»ºç³»ç»Ÿé•œåƒ
dd if=/dev/sda of=/backup/system_$(date +%Y%m%d).img bs=4M status=progress

# ä½¿ç”¨Clonezillaå¤‡ä»½
clonezilla save disk /dev/sda /backup/clonezilla/
```

2. ç³»ç»Ÿé…ç½®
```bash
# å¤‡ä»½ç³»ç»Ÿé…ç½®
tar czf /backup/etc_$(date +%Y%m%d).tar.gz /etc/

# å¤‡ä»½ç”¨æˆ·æ•°æ®
tar czf /backup/home_$(date +%Y%m%d).tar.gz /home/
```

## å¤‡ä»½éªŒè¯ä¸æ¢å¤
### å¤‡ä»½éªŒè¯
1. å®Œæ•´æ€§æ£€æŸ¥
```bash
# æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§
md5sum /backup/backup_*.tar.gz > /backup/checksums.md5
cd /backup && md5sum -c checksums.md5

# æ£€æŸ¥å‹ç¼©æ–‡ä»¶
gzip -t backup_*.gz
```

2. æ¢å¤æµ‹è¯•
```bash
# æµ‹è¯•æ–‡ä»¶æ¢å¤
mkdir /tmp/restore
tar xzf /backup/backup_20240321.tar.gz -C /tmp/restore/

# æµ‹è¯•æ•°æ®åº“æ¢å¤
mysql -u root -p < /backup/mysql/20240321/full_backup.sql
```

### æ•°æ®æ¢å¤
1. æ–‡ä»¶æ¢å¤
```bash
# ä»å¤‡ä»½æ¢å¤æ–‡ä»¶
tar xzf /backup/backup_20240321.tar.gz -C /
rsync -avz /backup/20240321/ /

# ä»å¿«ç…§æ¢å¤
lvconvert --merge /dev/vg_system/snap_root
zfs rollback tank/data@backup_20240321
```

2. æ•°æ®åº“æ¢å¤
```bash
# MySQLæ¢å¤
mysql -u root -p < /backup/mysql/20240321/full_backup.sql
mysqlbinlog /backup/mysql/binlog/* | mysql -u root -p

# PostgreSQLæ¢å¤
pg_restore -U postgres -d database_name /backup/postgresql/20240321/backup.dump
```

## ç›‘æ§ä¸ç»´æŠ¤
### å¤‡ä»½ç›‘æ§
1. çŠ¶æ€ç›‘æ§
```bash
# æ£€æŸ¥å¤‡ä»½ä»»åŠ¡çŠ¶æ€
bacula-dir -t
amanda status DailySet

# æ£€æŸ¥å¤‡ä»½ç©ºé—´
df -h /backup
du -sh /backup/*
```

2. å‘Šè­¦é…ç½®
```bash
#!/bin/bash
# å¤‡ä»½ç›‘æ§è„šæœ¬
if [ ! -f /backup/backup_$(date +%Y%m%d).tar.gz ]; then
    echo "Backup failed!" | mail -s "Backup Alert" admin@example.com
fi
```

### ç»´æŠ¤ç®¡ç†
1. æ—¥å¿—ç®¡ç†
```bash
# å¤‡ä»½æ—¥å¿—è½®è½¬
/var/log/backup/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
}
```

2. å­˜å‚¨ç®¡ç†
```bash
# æ¸…ç†è¿‡æœŸå¤‡ä»½
find /backup -type f -name "*.tar.gz" -mtime +30 -delete

# æ•´ç†å¤‡ä»½å­˜å‚¨
du -sh /backup/* | sort -hr
```

## æœ€ä½³å®è·µ
### å¤‡ä»½ç­–ç•¥
1. åˆ¶å®šå¤‡ä»½è®¡åˆ’
   - ç¡®å®šå¤‡ä»½å¯¹è±¡
   - é€‰æ‹©å¤‡ä»½æ–¹å¼
   - è®¾ç½®å¤‡ä»½å‘¨æœŸ
   - è§„åˆ’å­˜å‚¨ç©ºé—´

2. å®‰å…¨è€ƒè™‘
   - åŠ å¯†å¤‡ä»½æ•°æ®
   - å¼‚åœ°å­˜å‚¨å¤‡ä»½
   - è®¿é—®æƒé™æ§åˆ¶
   - å¤‡ä»½ä»‹è´¨ç®¡ç†

### è¿ç»´å»ºè®®
1. æ—¥å¸¸è¿ç»´
   - å®šæœŸæ£€æŸ¥å¤‡ä»½
   - æµ‹è¯•æ¢å¤æµç¨‹
   - æ›´æ–°å¤‡ä»½é…ç½®
   - ç»´æŠ¤å­˜å‚¨ç©ºé—´

2. åº”æ€¥å¤„ç†
   - åˆ¶å®šæ¢å¤æµç¨‹
   - å‡†å¤‡åº”æ€¥é¢„æ¡ˆ
   - å®šæœŸæ¼”ç»ƒ
   - æ–‡æ¡£æ›´æ–°

## å‚è€ƒèµ„æ–™
- [Baculaæ–‡æ¡£](https://www.bacula.org/documentation/)
- [Amandaæ–‡æ¡£](http://www.amanda.org/docs/)
- [rsyncæ–‡æ¡£](https://rsync.samba.org/documentation.html)

## ç›¸å…³æ–‡æ¡£
- [å­˜å‚¨æ–¹æ¡ˆè®¾è®¡](./01_å­˜å‚¨æ–¹æ¡ˆè®¾è®¡.md)
- [å­˜å‚¨ç®¡ç†æœ€ä½³å®è·µ](./03_å­˜å‚¨ç®¡ç†æœ€ä½³å®è·µ.md) 