# ä»£ç†æœåŠ¡éƒ¨ç½²

## æ–‡æ¡£ä¿¡æ¯
- ç‰ˆæœ¬: v1.0.0
- æ›´æ–°æ—¶é—´: 2024-03-21
- çŠ¶æ€: [ğŸ—ï¸è¿›è¡Œä¸­]
- ä½œè€…: System Admin

## ä¿®è®¢å†å²
| ç‰ˆæœ¬ | æ—¥æœŸ | æè¿° | ä½œè€… |
|-----|------|-----|-----|
| v1.0.0 | 2024-03-21 | åˆå§‹ç‰ˆæœ¬ | System Admin |

## æ–‡æ¡£è¯´æ˜
### ç›®æ ‡è¯»è€…
- ç³»ç»Ÿç®¡ç†å‘˜
- ç½‘ç»œå·¥ç¨‹å¸ˆ
- è¿ç»´å·¥ç¨‹å¸ˆ
- å®‰å…¨å·¥ç¨‹å¸ˆ

### å‰ç½®çŸ¥è¯†
- Linuxç³»ç»ŸåŸºç¡€
- ç½‘ç»œåè®®åŸºç¡€
- ä»£ç†æœåŠ¡åŸç†
- åŸºæœ¬å®‰å…¨æ¦‚å¿µ

## ä»£ç†æœåŠ¡æ¦‚è¿°
### ä»£ç†ç±»å‹
1. æ­£å‘ä»£ç†
   - HTTPä»£ç†
   - SOCKSä»£ç†
   - é€æ˜ä»£ç†
   - åŒ¿åä»£ç†

2. åå‘ä»£ç†
   - è´Ÿè½½å‡è¡¡
   - ç¼“å­˜åŠ é€Ÿ
   - å®‰å…¨é˜²æŠ¤
   - å†…å®¹è·¯ç”±

### åº”ç”¨åœºæ™¯
1. è®¿é—®æ§åˆ¶
   - ä¸Šç½‘è¡Œä¸ºç®¡ç†
   - å†…å®¹è¿‡æ»¤
   - è®¿é—®é™åˆ¶
   - æµé‡ç›‘æ§

2. æ€§èƒ½ä¼˜åŒ–
   - è´Ÿè½½å‡è¡¡
   - ç¼“å­˜åŠ é€Ÿ
   - å¸¦å®½ä¼˜åŒ–
   - è¿æ¥å¤ç”¨

3. å®‰å…¨é˜²æŠ¤
   - è®¿é—®æ§åˆ¶
   - å†…å®¹è¿‡æ»¤
   - DDoSé˜²æŠ¤
   - SSLç»ˆç»“

## Nginxä»£ç†é…ç½®
### åå‘ä»£ç†é…ç½®
```nginx
# åŸºæœ¬åå‘ä»£ç†
server {
    listen 80;
    server_name example.com;

    location / {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# è´Ÿè½½å‡è¡¡é…ç½®
upstream backend {
    server 192.168.1.10:8080 weight=3;
    server 192.168.1.11:8080 weight=2;
    server 192.168.1.12:8080 weight=1;
    keepalive 32;
}

# SSLé…ç½®
server {
    listen 443 ssl;
    server_name example.com;

    ssl_certificate /etc/nginx/ssl/example.com.crt;
    ssl_certificate_key /etc/nginx/ssl/example.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    location / {
        proxy_pass http://backend;
        proxy_ssl_session_reuse on;
    }
}
```

### ç¼“å­˜é…ç½®
```nginx
# ç¼“å­˜è®¾ç½®
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=10g inactive=60m;

server {
    location / {
        proxy_cache my_cache;
        proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
        proxy_cache_valid 200 302 10m;
        proxy_cache_valid 404 1m;
    }
}
```

## HAProxyé…ç½®
### å®‰è£…éƒ¨ç½²
```bash
# Ubuntu/Debian
apt update
apt install haproxy

# CentOS/RHEL
yum install haproxy

# å¯åŠ¨æœåŠ¡
systemctl start haproxy
systemctl enable haproxy
```

### åŸºç¡€é…ç½®
```bash
# /etc/haproxy/haproxy.cfg
global
    log /dev/log local0
    maxconn 4096
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    retries 3
    timeout connect 5000
    timeout client  50000
    timeout server  50000

frontend http-in
    bind *:80
    default_backend servers

backend servers
    balance roundrobin
    option httpchk HEAD / HTTP/1.1\r\nHost:\ localhost
    server server1 192.168.1.10:80 check
    server server2 192.168.1.11:80 check
    server server3 192.168.1.12:80 check
```

### SSLç»ˆç»“é…ç½®
```bash
frontend https-in
    bind *:443 ssl crt /etc/ssl/example.com.pem
    reqadd X-Forwarded-Proto:\ https
    default_backend servers

backend servers
    balance roundrobin
    option httpchk HEAD / HTTP/1.1\r\nHost:\ localhost
    server server1 192.168.1.10:80 check
    server server2 192.168.1.11:80 check
```

## Squidä»£ç†é…ç½®
### å®‰è£…éƒ¨ç½²
```bash
# Ubuntu/Debian
apt update
apt install squid

# CentOS/RHEL
yum install squid

# å¯åŠ¨æœåŠ¡
systemctl start squid
systemctl enable squid
```

### åŸºç¡€é…ç½®
```bash
# /etc/squid/squid.conf
http_port 3128
cache_mem 256 MB
maximum_object_size 4 MB
cache_dir ufs /var/spool/squid 100 16 256

# è®¿é—®æ§åˆ¶
acl localnet src 192.168.0.0/16
http_access allow localnet
http_access deny all

# ç¼“å­˜è®¾ç½®
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320
```

### è®¤è¯é…ç½®
```bash
# åŸºæœ¬è®¤è¯
auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/passwd
auth_param basic realm proxy
acl authenticated proxy_auth REQUIRED
http_access allow authenticated

# åˆ›å»ºç”¨æˆ·
htpasswd -c /etc/squid/passwd username
```

## æ€§èƒ½ä¼˜åŒ–
### ç³»ç»Ÿä¼˜åŒ–
```bash
# /etc/sysctl.conf
# è¿æ¥ä¼˜åŒ–
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 1200
net.ipv4.tcp_max_syn_backlog = 8192
net.ipv4.tcp_tw_reuse = 1

# å†…å­˜ä¼˜åŒ–
net.ipv4.tcp_wmem = 4096 87380 16777216
net.ipv4.tcp_rmem = 4096 87380 16777216
net.core.wmem_max = 16777216
net.core.rmem_max = 16777216
```

### ä»£ç†ä¼˜åŒ–
1. Nginxä¼˜åŒ–
   ```nginx
   worker_processes auto;
   worker_rlimit_nofile 65535;
   events {
       worker_connections 65535;
       use epoll;
       multi_accept on;
   }
   ```

2. Squidä¼˜åŒ–
   ```bash
   cache_mem 1024 MB
   maximum_object_size_in_memory 512 KB
   memory_pools on
   memory_pools_limit 32 MB
   ```

3. HAProxyä¼˜åŒ–
   ```bash
   global
       maxconn 100000
       tune.ssl.default-dh-param 2048
       ssl-default-bind-ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256
   ```

## ç›‘æ§ä¸ç»´æŠ¤
### æ€§èƒ½ç›‘æ§
```bash
# NginxçŠ¶æ€ç›‘æ§
location /nginx_status {
    stub_status on;
    access_log off;
    allow 127.0.0.1;
    deny all;
}

# HAProxyç»Ÿè®¡ä¿¡æ¯
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
```

### æ—¥å¿—ç®¡ç†
```bash
# Nginxæ—¥å¿—é…ç½®
log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                '$status $body_bytes_sent "$http_referer" '
                '"$http_user_agent" "$http_x_forwarded_for"';

# æ—¥å¿—è½®è½¬
/var/log/nginx/*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    create 640 nginx adm
    sharedscripts
    postrotate
        [ -f /var/run/nginx.pid ] && kill -USR1 `cat /var/run/nginx.pid`
    endscript
}
```

## å®‰å…¨é…ç½®
### è®¿é—®æ§åˆ¶
```nginx
# IPé™åˆ¶
location / {
    allow 192.168.1.0/24;
    deny all;
}

# é€Ÿç‡é™åˆ¶
limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;
location / {
    limit_req zone=one burst=5;
}
```

### SSL/TLSé…ç½®
```nginx
ssl_protocols TLSv1.2 TLSv1.3;
ssl_prefer_server_ciphers on;
ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 10m;
ssl_stapling on;
ssl_stapling_verify on;
```

## æ•…éšœå¤„ç†
### å¸¸è§é—®é¢˜
1. è¿æ¥é—®é¢˜
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - éªŒè¯ç«¯å£çŠ¶æ€
   - æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
   - æŸ¥çœ‹é”™è¯¯æ—¥å¿—

2. æ€§èƒ½é—®é¢˜
   - æ£€æŸ¥ç³»ç»Ÿèµ„æº
   - åˆ†æè®¿é—®æ—¥å¿—
   - ä¼˜åŒ–é…ç½®å‚æ•°
   - å¢åŠ ç¡¬ä»¶èµ„æº

3. è¯ä¹¦é—®é¢˜
   - éªŒè¯è¯ä¹¦æœ‰æ•ˆæ€§
   - æ£€æŸ¥è¯ä¹¦é“¾å®Œæ•´æ€§
   - ç¡®è®¤ç§é’¥æƒé™
   - æ›´æ–°è¿‡æœŸè¯ä¹¦

## æœ€ä½³å®è·µ
1. æ¶æ„è®¾è®¡
   - åˆç†è§„åˆ’æ¶æ„
   - å®ç°é«˜å¯ç”¨
   - åšå¥½å®¹ç¾
   - é¢„ç•™æ‰©å±•ç©ºé—´

2. å®‰å…¨åŠ å›º
   - åŠæ—¶æ›´æ–°è¡¥ä¸
   - é…ç½®è®¿é—®æ§åˆ¶
   - å¯ç”¨å®‰å…¨åè®®
   - å®æ–½ç›‘æ§å®¡è®¡

3. è¿ç»´ç®¡ç†
   - æ ‡å‡†åŒ–é…ç½®
   - è‡ªåŠ¨åŒ–éƒ¨ç½²
   - å®šæœŸå¤‡ä»½
   - ç›‘æ§å‘Šè­¦

## å‚è€ƒèµ„æ–™
- [Nginxå®˜æ–¹æ–‡æ¡£](https://nginx.org/en/docs/)
- [HAProxyæ–‡æ¡£](http://www.haproxy.org/#docs)
- [Squidç”¨æˆ·æŒ‡å—](http://www.squid-cache.org/Doc/)

## ç›¸å…³æ–‡æ¡£
- [åŸºç¡€æœåŠ¡é…ç½®](./01_åŸºç¡€æœåŠ¡é…ç½®.md)
- [å®‰å…¨æœåŠ¡å®æ–½](./03_å®‰å…¨æœåŠ¡å®æ–½.md)
