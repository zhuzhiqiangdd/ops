# Ansibleæœ€ä½³å®è·µæŒ‡å—

## ç‰ˆæœ¬ä¿¡æ¯
- ç‰ˆæœ¬å·: v1.0.0
- æ›´æ–°æ—¥æœŸ: 2024-03-21
- çŠ¶æ€: [ğŸ—ï¸è¿›è¡Œä¸­]

## 1. æ¦‚è¿°
æœ¬æ–‡æ¡£ä¸»è¦ä»‹ç»Ansibleçš„æœ€ä½³å®è·µå’Œæ¨èé…ç½®ã€‚

## 2. ç›®å½•ç»“æ„
### 2.1 æ ‡å‡†ç›®å½•ç»“æ„
```
production/                  # ç”Ÿäº§ç¯å¢ƒ
â”œâ”€â”€ ansible.cfg             # é…ç½®æ–‡ä»¶
â”œâ”€â”€ inventory/             # ä¸»æœºæ¸…å•ç›®å½•
â”‚   â”œâ”€â”€ group_vars/       # ç»„å˜é‡
â”‚   â”‚   â”œâ”€â”€ all.yml      # å…¨å±€å˜é‡
â”‚   â”‚   â”œâ”€â”€ webservers.yml
â”‚   â”‚   â””â”€â”€ dbservers.yml
â”‚   â”œâ”€â”€ host_vars/        # ä¸»æœºå˜é‡
â”‚   â”‚   â”œâ”€â”€ web1.yml
â”‚   â”‚   â””â”€â”€ db1.yml
â”‚   â”œâ”€â”€ production       # ç”Ÿäº§ç¯å¢ƒä¸»æœºæ¸…å•
â”‚   â””â”€â”€ staging         # æµ‹è¯•ç¯å¢ƒä¸»æœºæ¸…å•
â”œâ”€â”€ roles/               # è§’è‰²ç›®å½•
â”‚   â”œâ”€â”€ common/         # é€šç”¨è§’è‰²
â”‚   â”œâ”€â”€ webserver/      # WebæœåŠ¡å™¨è§’è‰²
â”‚   â””â”€â”€ dbserver/       # æ•°æ®åº“æœåŠ¡å™¨è§’è‰²
â”œâ”€â”€ playbooks/          # Playbookç›®å½•
â”‚   â”œâ”€â”€ site.yml       # ä¸»Playbook
â”‚   â”œâ”€â”€ webserver.yml  # WebæœåŠ¡å™¨é…ç½®
â”‚   â””â”€â”€ dbserver.yml   # æ•°æ®åº“æœåŠ¡å™¨é…ç½®
â””â”€â”€ library/           # è‡ªå®šä¹‰æ¨¡å—ç›®å½•
```

### 2.2 è§’è‰²ç»“æ„
```
roles/
  webserver/
    tasks/
      main.yml          # ä¸»ä»»åŠ¡æ–‡ä»¶
      install.yml       # å®‰è£…ä»»åŠ¡
      configure.yml     # é…ç½®ä»»åŠ¡
    handlers/
      main.yml         # å¤„ç†å™¨
    templates/
      nginx.conf.j2    # é…ç½®æ¨¡æ¿
    files/
      ssl/            # é™æ€æ–‡ä»¶
    vars/
      main.yml        # è§’è‰²å˜é‡
    defaults/
      main.yml        # é»˜è®¤å˜é‡
    meta/
      main.yml        # è§’è‰²å…ƒæ•°æ®
```

## 3. å‘½åè§„èŒƒ
### 3.1 æ–‡ä»¶å‘½å
- ä½¿ç”¨å°å†™å­—æ¯
- ä½¿ç”¨ä¸‹åˆ’çº¿åˆ†éš”
- ä½¿ç”¨æœ‰æ„ä¹‰çš„åç§°
- ä¿æŒä¸€è‡´æ€§

### 3.2 å˜é‡å‘½å
```yaml
# å¥½çš„å‘½å
http_port: 80
max_clients: 200
enable_ssl: true

# ä¸å¥½çš„å‘½å
Port: 80
MAXCLIENTS: 200
enableSSL: true
```

## 4. å˜é‡ç®¡ç†
### 4.1 å˜é‡ä¼˜å…ˆçº§
1. å‘½ä»¤è¡Œå˜é‡
2. ä¸»æœºå˜é‡
3. ç»„å˜é‡
4. è§’è‰²é»˜è®¤å˜é‡

### 4.2 å˜é‡æ–‡ä»¶ç»„ç»‡
```yaml
# group_vars/all.yml
---
# å…¨å±€è®¾ç½®
timezone: Asia/Shanghai
ntp_servers:
  - ntp1.example.com
  - ntp2.example.com

# group_vars/webservers.yml
---
# WebæœåŠ¡å™¨è®¾ç½®
http_port: 80
max_clients: 200
```

## 5. ä»»åŠ¡ç¼–å†™
### 5.1 ä»»åŠ¡å‘½å
```yaml
# å¥½çš„å‘½å
- name: Install nginx package
  apt:
    name: nginx
    state: present

# ä¸å¥½çš„å‘½å
- name: nginx
  apt:
    name: nginx
    state: present
```

### 5.2 æ¨¡å—ä½¿ç”¨
```yaml
# æ¨èä½¿ç”¨
- name: Ensure nginx is installed
  apt:
    name: nginx
    state: present
    update_cache: yes

# ä¸æ¨èä½¿ç”¨
- name: Install nginx
  command: apt-get install nginx
```

## 6. å®‰å…¨å®è·µ
### 6.1 æ•æ„Ÿæ•°æ®ç®¡ç†
```yaml
# ä½¿ç”¨Ansible Vault
- name: Configure database
  mysql_user:
    name: "{{ db_user }}"
    password: "{{ db_password }}"
  no_log: true  # ä¸è®°å½•æ•æ„Ÿä¿¡æ¯
```

### 6.2 æƒé™æ§åˆ¶
```yaml
# æœ€å°æƒé™åŸåˆ™
- name: Copy configuration
  copy:
    src: nginx.conf
    dest: /etc/nginx/nginx.conf
    owner: root
    group: root
    mode: '0644'
```

## 7. æ€§èƒ½ä¼˜åŒ–
### 7.1 å¹¶è¡Œæ‰§è¡Œ
```ini
# ansible.cfg
[defaults]
forks = 20
pipelining = True
```

### 7.2 SSHä¼˜åŒ–
```ini
# ansible.cfg
[ssh_connection]
ssh_args = -C -o ControlMaster=auto -o ControlPersist=60s
control_path = %(directory)s/ansible-ssh-%%h-%%p-%%r
```

## 8. è°ƒè¯•æŠ€å·§
### 8.1 è°ƒè¯•æ¨¡å¼
```yaml
# ä½¿ç”¨debugæ¨¡å—
- name: Debug variable
  debug:
    var: some_variable
    verbosity: 2

# ä½¿ç”¨whenæ¡ä»¶
- name: Show debug info
  debug:
    msg: "Current state: {{ state }}"
  when: debug_enabled | default(false)
```

### 8.2 é”™è¯¯å¤„ç†
```yaml
# ä»»åŠ¡çº§åˆ«
- name: Attempt risky operation
  command: /usr/local/bin/risky-operation
  ignore_errors: yes
  register: result

# Playçº§åˆ«
- hosts: webservers
  any_errors_fatal: true
  max_fail_percentage: 30
```

## 9. æµ‹è¯•å’ŒéªŒè¯
### 9.1 è¯­æ³•æ£€æŸ¥
```bash
# æ£€æŸ¥playbookè¯­æ³•
ansible-playbook site.yml --syntax-check

# æµ‹è¯•è¿è¡Œ
ansible-playbook site.yml --check
```

### 9.2 æµ‹è¯•ç¯å¢ƒ
```ini
# inventory/staging
[webservers]
web-staging[1:2].example.com

[dbservers]
db-staging[1:2].example.com
```

## 10. ç‰ˆæœ¬æ§åˆ¶
### 10.1 Gitè§„èŒƒ
```bash
# .gitignore
*.retry
*.pyc
.vault_pass
vault.yml
```

### 10.2 åˆ†æ”¯ç­–ç•¥
- master: ç”Ÿäº§ç¯å¢ƒä»£ç 
- develop: å¼€å‘åˆ†æ”¯
- feature/*: ç‰¹æ€§åˆ†æ”¯
- hotfix/*: ç´§æ€¥ä¿®å¤

## 11. æ–‡æ¡£ç®¡ç†
### 11.1 æ³¨é‡Šè§„èŒƒ
```yaml
# playbookæ³¨é‡Š
---
# ç”¨é€”: WebæœåŠ¡å™¨é…ç½®
# ä½œè€…: Your Name
# æ›´æ–°: 2024-03-21
- hosts: webservers
  # ä½¿ç”¨sudoæƒé™
  become: yes
  tasks:
    # å®‰è£…å¿…è¦çš„åŒ…
    - name: Install required packages
      apt:
        name: "{{ item }}"
        state: present
      loop:
        - nginx
        - php-fpm
```

### 11.2 READMEç¼–å†™
```markdown
# WebæœåŠ¡å™¨é…ç½®

## åŠŸèƒ½
- å®‰è£…å’Œé…ç½®Nginx
- PHP-FPMé…ç½®
- SSLè¯ä¹¦ç®¡ç†

## ä½¿ç”¨æ–¹æ³•
1. æ›´æ–°inventoryæ–‡ä»¶
2. é…ç½®group_vars
3. æ‰§è¡Œplaybook
```

## 12. å‚è€ƒèµ„æ–™
1. [Ansibleæœ€ä½³å®è·µ](https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html)
2. [Ansibleç›®å½•ç»“æ„](https://docs.ansible.com/ansible/latest/user_guide/sample_setup.html)
3. [Ansibleå®‰å…¨æŒ‡å—](https://docs.ansible.com/ansible/latest/user_guide/playbooks_vault.html) 